<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="GDM2026.Views.MessagesPage"
             BackgroundColor="#0B0B0B"
             Title="Messages">

    <ContentPage.Resources>
        <Color x:Key="GoldText">#D4AF37</Color>
        <Color x:Key="CardBackground">#151515</Color>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="18">

            <Border Background="{StaticResource CardBackground}"
                    Stroke="#000000"
                    StrokeThickness="1.5"
                    Padding="20">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18" />
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="16">
                    <Label Text="Messagerie"
                           FontSize="28"
                           FontAttributes="Bold"
                           HorizontalTextAlignment="Center"
                           TextColor="{StaticResource GoldText}" />

                    <Label Text="{Binding FeedbackMessage}"
                           TextColor="{Binding FeedbackColor}"
                           FontSize="14"
                           HorizontalTextAlignment="Center"
                           LineBreakMode="WordWrap" />

                    <Label Text="Chargez les messages, puis sélectionnez un élément à traiter. En mode « Autres », la sélection est désactivée."
                           FontSize="13"
                           HorizontalTextAlignment="Center"
                           TextColor="{StaticResource GoldText}"
                           Opacity="0.75" />

                    <Grid ColumnDefinitions="*,Auto"
                          ColumnSpacing="12"
                          RowDefinitions="Auto,Auto">

                        <Button Text="{Binding PendingButtonText}"
                                Command="{Binding LoadPendingCommand}"
                                BackgroundColor="#C18F1A"
                                TextColor="{StaticResource GoldText}"
                                Grid.Row="0"
                                Grid.Column="0"
                                ZIndex="10" />

                        <Button Text="{Binding OtherButtonText}"
                                Command="{Binding LoadOtherCommand}"
                                BackgroundColor="#303030"
                                TextColor="{StaticResource GoldText}"
                                Grid.Row="0"
                                Grid.Column="1"
                                ZIndex="10" />

                        <ActivityIndicator Grid.Row="1"
                                           Grid.ColumnSpan="2"
                                           IsRunning="{Binding IsLoading}"
                                           IsVisible="{Binding IsLoading}"
                                           Color="{StaticResource GoldText}"
                                           HorizontalOptions="Center"
                                           InputTransparent="True" />
                    </Grid>

                </VerticalStackLayout>
            </Border>

            <Border Background="#1E1E1E"
                   Padding="14"
                   Stroke="#2D2D2D">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="12">
                    <Label Text="Messages affichés"
                           FontAttributes="Bold"
                           TextColor="{StaticResource GoldText}"
                           FontSize="18" />

                    <CollectionView x:Name="MessagesCollection"
                                    ItemsSource="{Binding DisplayMessages}"
                                    SelectionMode="{Binding SelectionMode}"
                                    SelectedItem="{Binding SelectedMessage}"
                                    ItemSizingStrategy="MeasureAllItems"
                                    HeightRequest="420">

                        <CollectionView.EmptyView>
                            <VerticalStackLayout Padding="20" Spacing="8">
                                <Label Text="Aucun message à afficher."
                                       TextColor="{StaticResource GoldText}"
                                       HorizontalTextAlignment="Center"
                                       Opacity="0.7" />
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>

                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Vertical" ItemSpacing="10" />
                        </CollectionView.ItemsLayout>

                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border x:Name="ItemBorder"
                                        BackgroundColor="#111111"
                                        Stroke="#2D2D2D"
                                        StrokeThickness="1"
                                        Padding="12"
                                        Margin="0,4">

                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="14" />
                                    </Border.StrokeShape>

                                    <VerticalStackLayout Spacing="6">

                                        <Label Text="{Binding DisplayDate}"
                                               TextColor="{StaticResource GoldText}"
                                               FontAttributes="Bold" />

                                        <Label Text="{Binding Message}"
                                               TextColor="{StaticResource GoldText}"
                                               FontSize="14"
                                               LineBreakMode="WordWrap" />

                                        <Label Text="{Binding Reponse}"
                                               TextColor="{StaticResource GoldText}"
                                               FontSize="13"
                                               LineBreakMode="WordWrap"
                                               Opacity="0.85" />

                                        <Label Text="{Binding Etat}"
                                               TextColor="{StaticResource GoldText}"
                                               FontSize="12"
                                               Opacity="0.8" />

                                    </VerticalStackLayout>

                                    <VisualStateManager.VisualStateGroups>
                                        <VisualStateGroup x:Name="SelectionStates">

                                            <VisualState x:Name="Normal">
                                                <VisualState.Setters>
                                                    <Setter TargetName="ItemBorder" Property="Stroke" Value="#2D2D2D" />
                                                    <Setter TargetName="ItemBorder" Property="StrokeThickness" Value="1" />
                                                </VisualState.Setters>
                                            </VisualState>

                                            <VisualState x:Name="Selected">
                                                <VisualState.Setters>
                                                    <Setter TargetName="ItemBorder" Property="Stroke" Value="{StaticResource GoldText}" />
                                                    <Setter TargetName="ItemBorder" Property="StrokeThickness" Value="3" />
                                                </VisualState.Setters>

                                                <VisualState.StateTriggers>
                                                    <StateTrigger IsActive="{Binding BindingContext.IsShowingOthers, Source={x:Reference MessagesCollection}}" />
                                                </VisualState.StateTriggers>
                                            </VisualState>

                                        </VisualStateGroup>
                                    </VisualStateManager.VisualStateGroups>

                                </Border>

                            </DataTemplate>
                        </CollectionView.ItemTemplate>

                    </CollectionView>

                    <Label Text="Sélectionnez un message pour répondre (uniquement en mode « À traiter »)."
                           FontSize="12"
                           TextColor="{StaticResource GoldText}"
                           HorizontalTextAlignment="Center"
                           Opacity="0.75" />
                </VerticalStackLayout>
            </Border>

            <Border Background="#1E1E1E"
                   Padding="14"
                   Stroke="#2D2D2D"
                   IsVisible="{Binding IsReplySectionVisible}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="12">
                    <Label Text="Répondre au message sélectionné"
                           FontAttributes="Bold"
                           TextColor="{StaticResource GoldText}"
                           FontSize="18" />

                    <Label Text="{Binding SelectedMessage.DisplayDate, StringFormat='Reçu le {0}'}"
                           TextColor="{StaticResource GoldText}"
                           FontSize="13"
                           Opacity="0.85" />

                    <Label Text="{Binding SelectedMessage.Message}"
                           TextColor="{StaticResource GoldText}"
                           LineBreakMode="WordWrap"
                           FontSize="14" />

                    <Label Text="Réponse"
                           FontAttributes="Bold"
                           TextColor="{StaticResource GoldText}" />

                    <Editor Text="{Binding ReplyText}"
                            HeightRequest="120"
                            TextColor="{StaticResource GoldText}"
                            BackgroundColor="#121212"
                            Placeholder="Votre réponse..."
                            PlaceholderColor="#777" />

                    <Button Text="Envoyer"
                            Command="{Binding SendReplyCommand}"
                            BackgroundColor="#C18F1A"
                            TextColor="{StaticResource GoldText}" />

                    <ActivityIndicator IsRunning="{Binding IsSubmitting}"
                                       IsVisible="{Binding IsSubmitting}"
                                       Color="{StaticResource GoldText}"
                                       HorizontalOptions="Center" />
                </VerticalStackLayout>
            </Border>

            <BoxView HeightRequest="40"
                     InputTransparent="True" />

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
