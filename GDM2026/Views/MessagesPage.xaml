<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="GDM2026.Views.MessagesPage"
             BackgroundColor="#0B0B0B"
             Title="Messages">

    <ContentPage.Resources>
        <Color x:Key="GoldText">#D4AF37</Color>
        <Color x:Key="CardBackground">#151515</Color>
    </ContentPage.Resources>

    <CollectionView x:Name="MessagesCollection"
                    ItemsSource="{Binding DisplayMessages}"
                    SelectionMode="{Binding SelectionMode}"
                    SelectedItem="{Binding SelectedMessage}"
                    ItemSizingStrategy="MeasureAllItems"
                    Margin="0,0,0,12">

        <CollectionView.Footer>
            <BoxView HeightRequest="90" InputTransparent="True" />
        </CollectionView.Footer>

        <CollectionView.Header>
            <VerticalStackLayout Padding="20" Spacing="16">

                <Border Background="{StaticResource CardBackground}"
                        Stroke="#000"
                        StrokeThickness="1.5"
                        Padding="18">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="16" />
                    </Border.StrokeShape>

                    <VerticalStackLayout Spacing="12">

                        <Label Text="Messagerie"
                               FontSize="28"
                               FontAttributes="Bold"
                               TextColor="{StaticResource GoldText}"
                               HorizontalTextAlignment="Center" />

                        <Label Text="{Binding FeedbackMessage}"
                               TextColor="{Binding FeedbackColor}"
                               FontSize="14"
                               HorizontalTextAlignment="Center"
                               LineBreakMode="WordWrap" />

                        <Grid ColumnDefinitions="*,Auto"
                              ColumnSpacing="12"
                              RowDefinitions="Auto,Auto">

                            <Button Text="{Binding PendingButtonText}"
                                    Command="{Binding LoadPendingCommand}"
                                    BackgroundColor="#C18F1A"
                                    TextColor="{StaticResource GoldText}"
                                    Grid.Row="0"
                                    Grid.Column="0"
                                    ZIndex="10" />

                            <Button Text="{Binding OtherButtonText}"
                                    Command="{Binding LoadOtherCommand}"
                                    BackgroundColor="#303030"
                                    TextColor="{StaticResource GoldText}"
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    ZIndex="10" />

                            <ActivityIndicator Grid.Row="1"
                                               Grid.ColumnSpan="2"
                                               IsRunning="{Binding IsLoading}"
                                               IsVisible="{Binding IsLoading}"
                                               Color="{StaticResource GoldText}"
                                               HorizontalOptions="Center"
                                               InputTransparent="True" />
                        </Grid>

                    </VerticalStackLayout>
                </Border>

            </VerticalStackLayout>
        </CollectionView.Header>

        <CollectionView.EmptyView>
            <VerticalStackLayout Padding="20" Spacing="8">
                <Label Text="Aucun message à afficher."
                       TextColor="{StaticResource GoldText}"
                       HorizontalTextAlignment="Center"
                       Opacity="0.7" />
            </VerticalStackLayout>
        </CollectionView.EmptyView>

        <CollectionView.ItemsLayout>
            <LinearItemsLayout Orientation="Vertical" ItemSpacing="10" />
        </CollectionView.ItemsLayout>

        <CollectionView.ItemTemplate>
            <DataTemplate>

                <Border x:Name="ItemBorder"
                        BackgroundColor="#111111"
                        Stroke="#2D2D2D"
                        StrokeThickness="1"
                        Padding="12"
                        Margin="20,4">

                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="14" />
                    </Border.StrokeShape>

                    <VerticalStackLayout Spacing="6">

                        <Label Text="{Binding DisplayDate}"
                               TextColor="{StaticResource GoldText}"
                               FontAttributes="Bold" />

                        <Label Text="{Binding Message}"
                               TextColor="{StaticResource GoldText}"
                               FontSize="14"
                               LineBreakMode="WordWrap" />

                        <Label Text="{Binding Reponse}"
                               TextColor="{StaticResource GoldText}"
                               FontSize="13"
                               LineBreakMode="WordWrap"
                               Opacity="0.85" />

                        <Label Text="{Binding Etat}"
                               TextColor="{StaticResource GoldText}"
                               FontSize="12"
                               Opacity="0.8" />

                        <!-- Panneau réponse : uniquement en mode "À traiter" + item sélectionné -->
                        <VerticalStackLayout x:Name="ReplyPanel"
                                             IsVisible="False"
                                             Spacing="8">

                            <BoxView HeightRequest="1"
                                     BackgroundColor="#2D2D2D"
                                     Margin="0,8"
                                     InputTransparent="True" />

                            <Label Text="Répondre"
                                   TextColor="{StaticResource GoldText}"
                                   FontAttributes="Bold" />

                            <Editor Text="{Binding BindingContext.ReplyText, Source={x:Reference MessagesCollection}}"
                                    HeightRequest="90"
                                    TextColor="{StaticResource GoldText}"
                                    BackgroundColor="#121212"
                                    Placeholder="Votre réponse..."
                                    PlaceholderColor="#777" />

                            <Button Text="Envoyer"
                                    Command="{Binding BindingContext.SendReplyCommand, Source={x:Reference MessagesCollection}}"
                                    BackgroundColor="#C18F1A"
                                    TextColor="{StaticResource GoldText}" />

                            <ActivityIndicator IsRunning="{Binding BindingContext.IsSubmitting, Source={x:Reference MessagesCollection}}"
                                               IsVisible="{Binding BindingContext.IsSubmitting, Source={x:Reference MessagesCollection}}"
                                               Color="{StaticResource GoldText}"
                                               InputTransparent="True" />
                        </VerticalStackLayout>

                    </VerticalStackLayout>

                    <VisualStateManager.VisualStateGroups>
                        <VisualStateGroup x:Name="SelectionStates">

                            <VisualState x:Name="Normal">
                                <VisualState.Setters>
                                    <Setter TargetName="ItemBorder" Property="Stroke" Value="#2D2D2D" />
                                    <Setter TargetName="ItemBorder" Property="StrokeThickness" Value="1" />
                                    <Setter TargetName="ReplyPanel" Property="IsVisible" Value="False" />
                                </VisualState.Setters>
                            </VisualState>

                            <VisualState x:Name="Selected">
                                <VisualState.Setters>
                                    <Setter TargetName="ItemBorder" Property="Stroke" Value="{StaticResource GoldText}" />
                                    <Setter TargetName="ItemBorder" Property="StrokeThickness" Value="3" />
                                    <Setter TargetName="ReplyPanel" Property="IsVisible" Value="True" />
                                </VisualState.Setters>

                                <!-- En mode "autres", même si sélection arrive, on force à cacher -->
                                <VisualState.StateTriggers>
                                    <StateTrigger IsActive="{Binding BindingContext.IsShowingOthers, Source={x:Reference MessagesCollection}}" />
                                </VisualState.StateTriggers>
                            </VisualState>

                        </VisualStateGroup>
                    </VisualStateManager.VisualStateGroups>

                    <!-- Masque ReplyPanel si on est en mode "Autres" -->
                    <Border.Triggers>
                        <DataTrigger TargetType="Border"
                                     Binding="{Binding BindingContext.IsShowingOthers, Source={x:Reference MessagesCollection}}"
                                     Value="True">
                            <Setter TargetName="ReplyPanel" Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </Border.Triggers>

                </Border>

            </DataTemplate>
        </CollectionView.ItemTemplate>

    </CollectionView>
</ContentPage>
