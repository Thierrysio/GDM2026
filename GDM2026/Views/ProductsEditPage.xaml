<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="GDM2026.ProductsEditPage"
             x:Name="EditPage"
             BackgroundColor="#0B0B0B"
             Title="Modifier un produit">

    <Shell.BackButtonBehavior>
        <BackButtonBehavior Command="{Binding GoBackCommand}" />
    </Shell.BackButtonBehavior>

    <ContentPage.Resources>
        <Color x:Key="GoldText">#D4AF37</Color>
        <Color x:Key="CardBackground">#151515</Color>

        <!-- Styles simples pour homogeneiser -->
        <Style TargetType="Label">
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
        </Style>

        <Style TargetType="Entry">
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
        </Style>

        <Style TargetType="Editor">
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
        </Style>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="16">

            <!-- ================= HEADER ================= -->
            <Label Text="Modifier un produit"
                   FontSize="28"
                   FontAttributes="Bold"
                   HorizontalTextAlignment="Center" />

            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                <SearchBar Grid.Column="0"
                           Placeholder="Rechercher un produit"
                           Text="{Binding SearchText}"
                           SearchCommand="{Binding SearchProductsCommand}"
                           TextColor="{StaticResource GoldText}"
                           PlaceholderColor="#7E7030"
                           BackgroundColor="#111" />

                <Button Grid.Column="1"
                        Text="&#x1F50D;"
                        Command="{Binding SearchProductsCommand}"
                        BackgroundColor="#C18F1A"
                        TextColor="#0B0B0B" />
            </Grid>

            <Label Text="{Binding StatusMessage}"
                   FontSize="13"
                   Opacity="0.85" />

            <!-- ================= LISTE PRODUITS ================= -->
            <Border BackgroundColor="#101010"
                    Stroke="#000"
                    StrokeThickness="1"
                    Padding="12">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18" />
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="10">

                    <Label Text="Produits"
                           FontSize="16"
                           FontAttributes="Bold"
                           Opacity="0.95" />

                    <CollectionView ItemsSource="{Binding VisibleProducts}"
                                    SelectionMode="Single"
                                    SelectedItem="{Binding SelectedProduct, Mode=TwoWay}"
                                    RemainingItemsThreshold="3"
                                    RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">

                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Vertical"
                                               ItemSpacing="12" />
                        </CollectionView.ItemsLayout>

                        <CollectionView.EmptyView>
                            <Label Text="Aucun produit a afficher."
                                   HorizontalTextAlignment="Center"
                                   Opacity="0.85" />
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate>

                                <!-- Item cliquable sans Button.Content -->
                                <Border BackgroundColor="{StaticResource CardBackground}"
                                        Stroke="#000"
                                        StrokeThickness="1"
                                        Padding="0">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="16" />
                                    </Border.StrokeShape>

                                    <Grid Padding="14"
                                          ColumnDefinitions="Auto,*"
                                          ColumnSpacing="12">

                                        <Border WidthRequest="90"
                                                HeightRequest="90"
                                                Stroke="#333"
                                                BackgroundColor="#111">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12" />
                                            </Border.StrokeShape>

                                            <Image Source="{Binding PrimaryImageFullUrl}"
                                                   Aspect="AspectFill" />
                                        </Border>

                                        <VerticalStackLayout Grid.Column="1" Spacing="4">

                                            <Label Text="{Binding DisplayName}"
                                                   FontAttributes="Bold"
                                                   FontSize="16" />

                                            <Label Text="{Binding Description}"
                                                   FontSize="13"
                                                   Opacity="0.80"
                                                   LineBreakMode="TailTruncation"
                                                   MaxLines="2" />

                                            <Label Text="{Binding DisplayPrice}"
                                                   FontSize="14"
                                                   FontAttributes="Bold" />

                                            <Label Text="{Binding StockLabel}"
                                                   FontSize="12"
                                                   Opacity="0.95" />

                                        </VerticalStackLayout>

                                    </Grid>
                                </Border>

                            </DataTemplate>
                        </CollectionView.ItemTemplate>

                    </CollectionView>

                </VerticalStackLayout>
            </Border>

            <!-- ================= FORMULAIRE ================= -->
            <Border IsVisible="{Binding IsEditFormVisible}"
                   Padding="18"
                   Background="{StaticResource CardBackground}"
                   Stroke="#000">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18" />
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="12">

                    <Label Text="Modification du produit"
                           FontSize="18"
                           FontAttributes="Bold" />

                    <Label Text="{Binding EditStatusMessage}"
                           FontSize="13"
                           Opacity="0.85" />

                    <!-- NOM -->
                    <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                        <Label Text="Nom du produit" FontAttributes="Bold" />
                        <Label Text="&#x26A0;"
                               TextColor="Tomato"
                               FontAttributes="Bold"
                               IsVisible="{Binding IsNameMissing}" />
                    </HorizontalStackLayout>
                    <Entry Placeholder="Entrez le nom"
                           Text="{Binding EditProductName}" />

                    <!-- DESC COURTE -->
                    <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                        <Label Text="Description courte" FontAttributes="Bold" />
                        <Label Text="&#x26A0;"
                               TextColor="Tomato"
                               FontAttributes="Bold"
                               IsVisible="{Binding IsShortDescriptionMissing}" />
                    </HorizontalStackLayout>
                    <Editor Placeholder="Resume du produit"
                            HeightRequest="80"
                            Text="{Binding EditShortDescription}" />

                    <!-- DESC COMPLETE -->
                    <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                        <Label Text="Description complete" FontAttributes="Bold" />
                        <Label Text="&#x26A0;"
                               TextColor="Tomato"
                               FontAttributes="Bold"
                               IsVisible="{Binding IsFullDescriptionMissing}" />
                    </HorizontalStackLayout>
                    <Editor Placeholder="Description detaillee"
                            AutoSize="TextChanges"
                            MinimumHeightRequest="140"
                            Text="{Binding EditFullDescription}" />

                    <!-- PRIX + QUANTITE -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                            <HorizontalStackLayout Spacing="6">
                                <Label Text="Prix" FontAttributes="Bold" />
                                <Label Text="&#x26A0;"
                                       TextColor="Tomato"
                                       FontAttributes="Bold"
                                       IsVisible="{Binding IsPriceMissing}" />
                            </HorizontalStackLayout>
                            <Entry Placeholder="ex : 14.90"
                                   Keyboard="Numeric"
                                   Text="{Binding EditPriceText}" />
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="1" Spacing="4">
                            <HorizontalStackLayout Spacing="6">
                                <Label Text="Quantite" FontAttributes="Bold" />
                                <Label Text="&#x26A0;"
                                       TextColor="Tomato"
                                       FontAttributes="Bold"
                                       IsVisible="{Binding IsQuantityMissing}" />
                            </HorizontalStackLayout>
                            <Entry Placeholder="ex : 25"
                                   Keyboard="Numeric"
                                   Text="{Binding EditStockText}" />
                        </VerticalStackLayout>
                    </Grid>

                    <!-- CATEGORIE -->
                    <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                        <Label Text="Categorie" FontAttributes="Bold" />
                        <Label Text="&#x26A0;"
                               TextColor="Tomato"
                               FontAttributes="Bold"
                               IsVisible="{Binding IsCategoryMissing}" />
                    </HorizontalStackLayout>

                    <Label Text="{Binding CategoryStatusMessage}"
                           FontSize="12"
                           Opacity="0.85" />

                    <ActivityIndicator IsRunning="{Binding IsCategoryLoading}"
                                       IsVisible="{Binding IsCategoryLoading}"
                                       Color="{StaticResource GoldText}" />

                    <Picker ItemsSource="{Binding AvailableCategories}"
                            SelectedItem="{Binding SelectedCategory}"
                            ItemDisplayBinding="{Binding DisplayName}"
                            Title="Choisissez une categorie"
                            IsEnabled="{Binding IsCategorySelectionEnabled}"
                            TextColor="{StaticResource GoldText}"
                            BackgroundColor="#101010" />

                    <!-- IMAGE -->
                    <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                        <Label Text="{Binding SelectedImageName}"
                               FontAttributes="Bold" />
                        <Label Text="&#x26A0;"
                               TextColor="Tomato"
                               FontAttributes="Bold"
                               IsVisible="{Binding IsImageMissing}" />
                    </HorizontalStackLayout>

                    <Border BackgroundColor="#1B1B1B"
                            Stroke="#2D2D2D"
                            Padding="12">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="14" />
                        </Border.StrokeShape>

                        <VerticalStackLayout Spacing="8">

                            <SearchBar Placeholder="Rechercher une image"
                                       Text="{Binding ImageSearchTerm}"
                                       TextColor="{StaticResource GoldText}"
                                       PlaceholderColor="#7E7030"
                                       CancelButtonColor="{StaticResource GoldText}"
                                       BackgroundColor="#101010" />

                            <Label Text="{Binding ImageLibraryMessage}"
                                   FontSize="12"
                                   Opacity="0.8" />

                            <ActivityIndicator IsRunning="{Binding IsImageLibraryLoading}"
                                               IsVisible="{Binding IsImageLibraryLoading}"
                                               Color="{StaticResource GoldText}" />

                            <CollectionView ItemsSource="{Binding FilteredImageLibrary}"
                                            SelectionMode="Single"
                                            SelectedItem="{Binding SelectedLibraryImage}"
                                            HeightRequest="200">

                                <CollectionView.ItemsLayout>
                                    <GridItemsLayout Orientation="Vertical" Span="3" />
                                </CollectionView.ItemsLayout>

                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="4"
                                                Margin="4"
                                                BackgroundColor="#111"
                                                Stroke="#333">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="10" />
                                            </Border.StrokeShape>

                                            <VerticalStackLayout Spacing="4">
                                                <Image Source="{Binding FullUrl}"
                                                       HeightRequest="70"
                                                       Aspect="AspectFill" />
                                                <Label Text="{Binding DisplayName}"
                                                       FontSize="11"
                                                       LineBreakMode="TailTruncation"
                                                       HorizontalTextAlignment="Center" />
                                            </VerticalStackLayout>

                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>

                            </CollectionView>

                        </VerticalStackLayout>
                    </Border>

                    <!-- ACTIONS -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                        <Button Text="Reinitialiser"
                                Command="{Binding ResetFormCommand}"
                                BackgroundColor="#353535"
                                TextColor="{StaticResource GoldText}" />

                        <Button Grid.Column="1"
                                Text="Enregistrer les modifications"
                                Command="{Binding SaveChangesCommand}"
                                BackgroundColor="#C18F1A"
                                TextColor="#0B0B0B" />
                    </Grid>

                    <ActivityIndicator IsRunning="{Binding IsSaving}"
                                       IsVisible="{Binding IsSaving}"
                                       Color="{StaticResource GoldText}" />

                </VerticalStackLayout>
            </Border>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
