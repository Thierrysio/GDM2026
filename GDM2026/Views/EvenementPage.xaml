<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="GDM2026.Views.EvenementPage"
             BackgroundColor="#0B0B0B"
             Title="Catégories événements">

    <ContentPage.Resources>
        <Color x:Key="GoldText">#D4AF37</Color>
        <Color x:Key="CardBackground">#151515</Color>

        <Style x:Key="SectionTitleStyle" TargetType="Label">
            <Setter Property="FontSize" Value="22" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
        </Style>

        <Style x:Key="DarkEntryStyle" TargetType="Entry">
            <Setter Property="BackgroundColor" Value="#101010" />
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
            <Setter Property="PlaceholderColor" Value="#7E7030" />
            <Setter Property="FontSize" Value="16" />
            <Setter Property="HeightRequest" Value="46" />
            <Setter Property="Margin" Value="0,4,0,0" />
        </Style>

        <Style x:Key="BaseButtonStyle" TargetType="Button">
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="CornerRadius" Value="16" />
            <Setter Property="Padding" Value="18,12" />
            <Setter Property="BackgroundColor" Value="#2A2A2A" />
        </Style>

        <Style x:Key="PrimaryButtonStyle" TargetType="Button" BasedOn="{StaticResource BaseButtonStyle}">
            <Setter Property="BackgroundColor" Value="#C18F1A" />
        </Style>

        <Style x:Key="SecondaryButtonStyle" TargetType="Button" BasedOn="{StaticResource BaseButtonStyle}">
            <Setter Property="BackgroundColor" Value="#1F1F1F" />
        </Style>

        <Style x:Key="DangerButtonStyle" TargetType="Button" BasedOn="{StaticResource BaseButtonStyle}">
            <Setter Property="BackgroundColor" Value="#7A1C1C" />
        </Style>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="18">

            <!-- En-tête -->
            <Border Background="{StaticResource CardBackground}" Stroke="#000000" StrokeThickness="1.5" Padding="24">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="8">
                    <Label Text="Catégories événements"
                           FontSize="30"
                           FontAttributes="Bold"
                           HorizontalTextAlignment="Center"
                           TextColor="{StaticResource GoldText}" />
                    <Label Text="Créez, renommez et supprimez les catégories promo utilisées sur le site."
                           FontSize="16"
                           TextColor="{StaticResource GoldText}"
                           HorizontalTextAlignment="Center"
                           Opacity="0.85" />
                </VerticalStackLayout>
            </Border>

            <!-- Créer -->
            <Border Background="{StaticResource CardBackground}" Stroke="#000000" StrokeThickness="1.5" Padding="24">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18" />
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="12">
                    <Label Text="Créer un événement" Style="{StaticResource SectionTitleStyle}" />

                    <Label Text="{Binding StatusMessage}"
                           FontSize="14"
                           TextColor="{StaticResource GoldText}"
                           LineBreakMode="WordWrap"
                           Opacity="0.85" />

                    <VerticalStackLayout Spacing="10">
                        <Entry Placeholder="Nom de l'événement"
                               Text="{Binding NewCategoryName}"
                               Style="{StaticResource DarkEntryStyle}" />

                        <Button Text="Créer l'événement"
                                Command="{Binding CreateCommand}"
                                Style="{StaticResource PrimaryButtonStyle}" />
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Border>

            <!-- Modifier -->
            <Border Background="{StaticResource CardBackground}" Stroke="#000000" StrokeThickness="1.5" Padding="24">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18" />
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="12">
                    <Label Text="Modifier un événement" Style="{StaticResource SectionTitleStyle}" />

                    <Button Text="{Binding SelectionButtonText}"
                            Command="{Binding ShowSelectionCommand}"
                            Style="{StaticResource PrimaryButtonStyle}" />

                    <Label Text="{Binding SelectedCategoryName}"
                           FontSize="13"
                           TextColor="{StaticResource GoldText}"
                           Opacity="0.85"
                           LineBreakMode="WordWrap" />
                </VerticalStackLayout>
            </Border>

            <!-- Hint si liste cachée -->
            <Label Text="Appuyez sur « Modifier » pour afficher les événements."
                   FontSize="13"
                   TextColor="{StaticResource GoldText}"
                   Opacity="0.65">
                <Label.Triggers>
                    <DataTrigger TargetType="Label"
                                 Binding="{Binding IsSelectionVisible}"
                                 Value="True">
                        <Setter Property="IsVisible" Value="False" />
                    </DataTrigger>
                </Label.Triggers>
            </Label>

            <!-- Liste -->
            <Border Background="{StaticResource CardBackground}"
                    Stroke="#000000"
                    StrokeThickness="1.5"
                    Padding="24"
                    IsVisible="{Binding IsSelectionVisible}"
                    MinimumHeightRequest="680">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18" />
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="12"
                                     VerticalOptions="FillAndExpand">

                    <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                        <Label Text="Événements"
                               Style="{StaticResource SectionTitleStyle}" />
                        <ActivityIndicator Grid.Column="1"
                                           IsRunning="{Binding IsRefreshing}"
                                           IsVisible="{Binding IsRefreshing}"
                                           Color="{StaticResource GoldText}" />
                    </Grid>

                    <RefreshView Command="{Binding RefreshCommand}"
                                 IsRefreshing="{Binding IsRefreshing}"
                                 HeightRequest="600"
                                 VerticalOptions="FillAndExpand">

                        <CollectionView x:Name="EventsCollection"
                                        ItemsSource="{Binding PromoCategories}"
                                        SelectionMode="Single"
                                        SelectedItem="{Binding SelectedCategory}"
                                        SelectionChangedCommand="{Binding SelectionChangedCommand}"
                                        SelectionChangedCommandParameter="{Binding CurrentSelection[0], Source={RelativeSource Self}}"
                                        VerticalOptions="FillAndExpand"
                                        Margin="0,0,0,12"
                                        ItemSizingStrategy="MeasureAllItems">

                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="12" />
                            </CollectionView.ItemsLayout>

                            <CollectionView.EmptyView>
                                <Label Text="Aucun événement pour le moment."
                                       HorizontalTextAlignment="Center"
                                       TextColor="{StaticResource GoldText}"
                                       Opacity="0.6" />
                            </CollectionView.EmptyView>

                            <CollectionView.ItemTemplate>
                                <DataTemplate>

                                    <!-- Fond noir constant, surbrillance via Stroke/Shadow -->
                                    <Border x:Name="ItemBorder"
                                            BackgroundColor="#0B0B0B"
                                            Stroke="#2D2D2D"
                                            StrokeThickness="1.5"
                                            Padding="16">

                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="16" />
                                        </Border.StrokeShape>

                                        <VerticalStackLayout Spacing="4">

                                            <Label Text="{Binding DisplayName}"
                                                   FontSize="18"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource GoldText}" />

                                            <Label Text="{Binding Name}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource GoldText}"
                                                   Opacity="0.75" />

                                            <Label Text="{Binding Id, StringFormat='ID : {0}'}"
                                                   FontSize="12"
                                                   TextColor="{StaticResource GoldText}"
                                                   Opacity="0.55" />

                                            <BoxView HeightRequest="1"
                                                     BackgroundColor="#2D2D2D"
                                                     Margin="0,8" />

                                            <!-- Edition : apparaît uniquement sur Selected -->
                                            <VerticalStackLayout x:Name="EditPanel"
                                                                 Spacing="8"
                                                                 IsVisible="False">

                                                <Label Text="Modifier cet événement"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       TextColor="{StaticResource GoldText}" />

                                                <Entry Placeholder="Nouveau titre de l'événement"
                                                       Text="{Binding BindingContext.EditCategoryName, Source={x:Reference EventsCollection}}"
                                                       Style="{StaticResource DarkEntryStyle}" />

                                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                                    <Button Text="Mettre à jour"
                                                            Command="{Binding BindingContext.UpdateCommand, Source={x:Reference EventsCollection}}"
                                                            Style="{StaticResource SecondaryButtonStyle}" />

                                                    <Button Grid.Column="1"
                                                            Text="Supprimer"
                                                            Command="{Binding BindingContext.DeleteCommand, Source={x:Reference EventsCollection}}"
                                                            Style="{StaticResource DangerButtonStyle}" />
                                                </Grid>
                                            </VerticalStackLayout>

                                        </VerticalStackLayout>

                                        <!-- États : surbrillance + panneau édition -->
                                        <VisualStateManager.VisualStateGroups>
                                            <VisualStateGroup x:Name="SelectionStates">

                                                <VisualState x:Name="Normal">
                                                    <VisualState.Setters>
                                                        <Setter TargetName="ItemBorder" Property="BackgroundColor" Value="#0B0B0B" />
                                                        <Setter TargetName="ItemBorder" Property="Stroke" Value="#2D2D2D" />
                                                        <Setter TargetName="ItemBorder" Property="StrokeThickness" Value="1.5" />
                                                        <Setter TargetName="ItemBorder" Property="Shadow" Value="{x:Null}" />
                                                        <Setter TargetName="EditPanel" Property="IsVisible" Value="False" />
                                                    </VisualState.Setters>
                                                </VisualState>

                                                <VisualState x:Name="Selected">
                                                    <VisualState.Setters>
                                                        <!-- fond reste noir -->
                                                        <Setter TargetName="ItemBorder" Property="BackgroundColor" Value="#0B0B0B" />

                                                        <!-- surbrillance -->
                                                        <Setter TargetName="ItemBorder" Property="Stroke" Value="{StaticResource GoldText}" />
                                                        <Setter TargetName="ItemBorder" Property="StrokeThickness" Value="3" />
                                                        <Setter TargetName="ItemBorder" Property="Shadow">
                                                            <Setter.Value>
                                                                <Shadow Opacity="0.85" Radius="18" />
                                                            </Setter.Value>
                                                        </Setter>

                                                        <Setter TargetName="EditPanel" Property="IsVisible" Value="True" />
                                                    </VisualState.Setters>
                                                </VisualState>

                                            </VisualStateGroup>
                                        </VisualStateManager.VisualStateGroups>

                                    </Border>

                                </DataTemplate>
                            </CollectionView.ItemTemplate>

                        </CollectionView>
                    </RefreshView>

                </VerticalStackLayout>
            </Border>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
