<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="GDM2026.VoteCollectifPage"
             x:Name="VotePageRoot"
             BackgroundColor="#0B0B0B">
    <ContentPage.Resources>
        <Color x:Key="GoldText">#D4AF37</Color>
        <Color x:Key="CardBackground">#151515</Color>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="18">

            <!-- Header -->
            <Border
                Background="{StaticResource CardBackground}"
                Stroke="#000000"
                StrokeThickness="1.5"
                Padding="20">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="12">
                    <Label
                        Text="Vote Collectif"
                        FontSize="28"
                        FontAttributes="Bold"
                        HorizontalTextAlignment="Center"
                        TextColor="{StaticResource GoldText}" />
                    <Label
                        Text="Votez pour les produits que vous aimeriez voir en rayon !"
                        FontSize="16"
                        HorizontalTextAlignment="Center"
                        TextColor="{StaticResource GoldText}"
                        Opacity="0.85" />
                </VerticalStackLayout>
            </Border>

            <!-- Loading indicator -->
            <ActivityIndicator
                IsRunning="{Binding IsLoadingSession}"
                IsVisible="{Binding IsLoadingSession}"
                Color="{StaticResource GoldText}"
                HeightRequest="40" />

            <!-- Session Info -->
            <Border
                IsVisible="{Binding HasActiveSession}"
                Background="{StaticResource CardBackground}"
                Stroke="#C18F1A"
                StrokeThickness="1.5"
                Padding="20">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label
                        Text="{Binding SessionTitle}"
                        FontSize="22"
                        FontAttributes="Bold"
                        TextColor="{StaticResource GoldText}" />
                    <Label
                        Text="{Binding SessionDescription}"
                        FontSize="14"
                        TextColor="{StaticResource GoldText}"
                        Opacity="0.85"
                        LineBreakMode="WordWrap" />
                    <HorizontalStackLayout Spacing="16">
                        <Label
                            Text="{Binding SessionPeriode}"
                            FontSize="13"
                            TextColor="{StaticResource GoldText}"
                            Opacity="0.7" />
                        <Label
                            Text="{Binding SessionStatut}"
                            FontSize="13"
                            FontAttributes="Bold"
                            TextColor="{StaticResource GoldText}" />
                    </HorizontalStackLayout>

                    <HorizontalStackLayout Spacing="10" HorizontalOptions="Center">
                        <Button
                            Text="Rafraichir"
                            BackgroundColor="#303030"
                            TextColor="{StaticResource GoldText}"
                            Command="{Binding RefreshCommand}"
                            FontSize="13"
                            Padding="12,8" />
                        <Button
                            Text="Voir les resultats"
                            BackgroundColor="#303030"
                            TextColor="{StaticResource GoldText}"
                            Command="{Binding VoirResultatsCommand}"
                            IsVisible="{Binding CanSeeResultats}"
                            FontSize="13"
                            Padding="12,8" />
                        <Button
                            Text="Retour aux produits"
                            BackgroundColor="#303030"
                            TextColor="{StaticResource GoldText}"
                            Command="{Binding RetourListeCommand}"
                            IsVisible="{Binding ShowResultats}"
                            FontSize="13"
                            Padding="12,8" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Border>

            <!-- Loading produits -->
            <ActivityIndicator
                IsRunning="{Binding IsLoadingProduits}"
                IsVisible="{Binding IsLoadingProduits}"
                Color="{StaticResource GoldText}"
                HeightRequest="40" />

            <!-- Produits list -->
            <CollectionView
                IsVisible="{Binding ShowProduits}"
                ItemsSource="{Binding Produits}"
                SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="12" />
                </CollectionView.ItemsLayout>
                <CollectionView.EmptyView>
                    <Label
                        Text="Aucun produit candidat pour cette session."
                        TextColor="{StaticResource GoldText}"
                        HorizontalTextAlignment="Center"
                        Opacity="0.6"
                        Margin="0,20" />
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border
                            Background="{StaticResource CardBackground}"
                            Stroke="#2D2D2D"
                            StrokeThickness="1"
                            Padding="16">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="14" />
                            </Border.StrokeShape>
                            <Grid ColumnDefinitions="90,*" ColumnSpacing="14">
                                <!-- Product Image -->
                                <Border
                                    Grid.Column="0"
                                    Background="#1E1E1E"
                                    HeightRequest="90"
                                    WidthRequest="90"
                                    StrokeThickness="0">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10" />
                                    </Border.StrokeShape>
                                    <Image
                                        Source="{Binding FullImageUrl}"
                                        Aspect="AspectFill"
                                        HeightRequest="90"
                                        WidthRequest="90" />
                                </Border>

                                <!-- Product Info -->
                                <VerticalStackLayout
                                    Grid.Column="1"
                                    Spacing="4"
                                    VerticalOptions="Center">
                                    <Label
                                        Text="{Binding DisplayName}"
                                        FontSize="16"
                                        FontAttributes="Bold"
                                        TextColor="{StaticResource GoldText}"
                                        LineBreakMode="TailTruncation" />
                                    <Label
                                        Text="{Binding DescriptionCourte}"
                                        FontSize="12"
                                        TextColor="{StaticResource GoldText}"
                                        Opacity="0.75"
                                        LineBreakMode="TailTruncation" />
                                    <HorizontalStackLayout Spacing="10">
                                        <Label
                                            Text="{Binding DisplayCategorie}"
                                            FontSize="11"
                                            TextColor="{StaticResource GoldText}"
                                            Opacity="0.6" />
                                        <Label
                                            Text="{Binding DisplayPrix}"
                                            FontSize="11"
                                            TextColor="{StaticResource GoldText}"
                                            Opacity="0.6" />
                                    </HorizontalStackLayout>
                                    <HorizontalStackLayout Spacing="10">
                                        <Label
                                            Text="{Binding MoyenneLabel}"
                                            FontSize="14"
                                            FontAttributes="Bold"
                                            TextColor="{StaticResource GoldText}" />
                                        <Label
                                            Text="{Binding VotesLabel}"
                                            FontSize="12"
                                            TextColor="{StaticResource GoldText}"
                                            Opacity="0.7" />
                                    </HorizontalStackLayout>
                                    <Label
                                        Text="{Binding UserVoteLabel}"
                                        FontSize="12"
                                        TextColor="{StaticResource GoldText}"
                                        Opacity="0.85" />
                                    <Button
                                        Text="Voter"
                                        BackgroundColor="#C18F1A"
                                        TextColor="#0B0B0B"
                                        FontSize="13"
                                        FontAttributes="Bold"
                                        Padding="14,6"
                                        HorizontalOptions="Start"
                                        Command="{Binding BindingContext.VoterCommand, Source={x:Reference VotePageRoot}}"
                                        CommandParameter="{Binding .}" />
                                </VerticalStackLayout>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Loading resultats -->
            <ActivityIndicator
                IsRunning="{Binding IsLoadingResultats}"
                IsVisible="{Binding IsLoadingResultats}"
                Color="{StaticResource GoldText}"
                HeightRequest="40" />

            <!-- Resultats list -->
            <VerticalStackLayout
                IsVisible="{Binding ShowResultats}"
                Spacing="12">
                <Label
                    Text="Classement"
                    FontSize="22"
                    FontAttributes="Bold"
                    TextColor="{StaticResource GoldText}"
                    HorizontalTextAlignment="Center" />

                <CollectionView
                    ItemsSource="{Binding Resultats}"
                    SelectionMode="None">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="10" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.EmptyView>
                        <Label
                            Text="Aucun resultat disponible."
                            TextColor="{StaticResource GoldText}"
                            HorizontalTextAlignment="Center"
                            Opacity="0.6"
                            Margin="0,20" />
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Border
                                Background="{StaticResource CardBackground}"
                                Stroke="#C18F1A"
                                StrokeThickness="1.2"
                                Padding="16">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="14" />
                                </Border.StrokeShape>
                                <Grid ColumnDefinitions="50,80,*" ColumnSpacing="12">
                                    <!-- Classement -->
                                    <VerticalStackLayout
                                        Grid.Column="0"
                                        VerticalOptions="Center"
                                        HorizontalOptions="Center">
                                        <Label
                                            Text="{Binding ClassementLabel}"
                                            FontSize="24"
                                            FontAttributes="Bold"
                                            TextColor="{StaticResource GoldText}"
                                            HorizontalTextAlignment="Center" />
                                    </VerticalStackLayout>

                                    <!-- Image -->
                                    <Border
                                        Grid.Column="1"
                                        Background="#1E1E1E"
                                        HeightRequest="70"
                                        WidthRequest="70"
                                        StrokeThickness="0">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="10" />
                                        </Border.StrokeShape>
                                        <Image
                                            Source="{Binding FullImageUrl}"
                                            Aspect="AspectFill"
                                            HeightRequest="70"
                                            WidthRequest="70" />
                                    </Border>

                                    <!-- Info -->
                                    <VerticalStackLayout
                                        Grid.Column="2"
                                        VerticalOptions="Center"
                                        Spacing="4">
                                        <Label
                                            Text="{Binding NomProduit}"
                                            FontSize="16"
                                            FontAttributes="Bold"
                                            TextColor="{StaticResource GoldText}"
                                            LineBreakMode="TailTruncation" />
                                        <HorizontalStackLayout Spacing="10">
                                            <Label
                                                Text="{Binding MoyenneLabel}"
                                                FontSize="14"
                                                FontAttributes="Bold"
                                                TextColor="{StaticResource GoldText}" />
                                            <Label
                                                Text="{Binding VotesLabel}"
                                                FontSize="12"
                                                TextColor="{StaticResource GoldText}"
                                                Opacity="0.7"
                                                VerticalTextAlignment="Center" />
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>

            <!-- Status Message -->
            <Label
                Text="{Binding StatusMessage}"
                TextColor="{Binding StatusColor}"
                FontSize="14"
                HorizontalTextAlignment="Center"
                LineBreakMode="WordWrap"
                Margin="0,8" />

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
