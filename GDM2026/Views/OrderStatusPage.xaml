<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="GDM2026.OrderStatusPage"
    BackgroundColor="#0B0B0B"
    Title="{Binding PageTitle}">

    <ContentPage.Resources>
        <Color x:Key="GoldText">#D4AF37</Color>
        <Color x:Key="CardBackground">#0B0B0B</Color>
        <Color x:Key="CardBorder">#000000</Color>

        <Style TargetType="Label">
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
        </Style>

        <Style TargetType="Picker">
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
            <Setter Property="TitleColor" Value="{StaticResource GoldText}" />
            <Setter Property="BackgroundColor" Value="Transparent" />
        </Style>

        <Style TargetType="DatePicker">
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
            <Setter Property="BackgroundColor" Value="#121212" />
        </Style>

        <Style TargetType="Button">
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
        </Style>

        <Style TargetType="ActivityIndicator">
            <Setter Property="Color" Value="{StaticResource GoldText}" />
        </Style>
    </ContentPage.Resources>

    <!-- ✅ CollectionView = scroll natif (pas de ScrollView autour) -->
    <CollectionView
        ItemsSource="{Binding Orders}"
        SelectionMode="None"
        ItemSizingStrategy="MeasureFirstItem"
        BackgroundColor="#0B0B0B">

        <!-- ✅ HEADER -->
        <CollectionView.Header>
            <VerticalStackLayout Padding="24" Spacing="16">

                <!-- Titre -->
                <Border
                    Background="{StaticResource CardBackground}"
                    Stroke="{StaticResource CardBorder}"
                    StrokeThickness="1.5"
                    Padding="24">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18" />
                    </Border.StrokeShape>

                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="22"
                            FontAttributes="Bold"
                            HorizontalTextAlignment="Center"
                            LineBreakMode="NoWrap"
                            MaxLines="1"
                            HorizontalOptions="Center"
                            Text="{Binding PageTitle}" />

                        <Label
                            FontSize="14"
                            HorizontalTextAlignment="Center"
                            Opacity="0.85"
                            Text="{Binding Subtitle}" />
                    </VerticalStackLayout>
                </Border>

                <!-- Bloc Réservations (tuiles + dates) -->
                <VerticalStackLayout Spacing="12" IsVisible="{Binding IsReservationMode}">

                    <!-- Tuiles statuts réservation -->
                    <CollectionView
                        ItemsSource="{Binding ReservationStatuses}"
                        ItemsLayout="HorizontalList"
                        SelectionMode="None"
                        HeightRequest="62">

                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    Margin="0,0,10,0"
                                    Padding="12,10"
                                    Stroke="{StaticResource GoldText}"
                                    StrokeThickness="1.2"
                                    BackgroundColor="#0B0B0B">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="14" />
                                    </Border.StrokeShape>

                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding BindingContext.SelectReservationStatusCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                            CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>

                                    <Border.Triggers>
                                        <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                            <Setter Property="BackgroundColor" Value="#121212" />
                                            <Setter Property="StrokeThickness" Value="2" />
                                        </DataTrigger>
                                    </Border.Triggers>

                                    <VerticalStackLayout Spacing="2">
                                        <Label Text="{Binding Status}" FontAttributes="Bold" FontSize="13" />
                                        <Label Text="{Binding Count, StringFormat='({0})'}" FontSize="12" Opacity="0.8" />
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Dates + appliquer -->
                    <Grid ColumnDefinitions="*,*" RowDefinitions="auto,auto" ColumnSpacing="10" RowSpacing="10">
                        <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="6">
                            <Label Text="Début" FontSize="12" Opacity="0.8" />
                            <DatePicker Date="{Binding StartDate}" />
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="6">
                            <Label Text="Fin" FontSize="12" Opacity="0.8" />
                            <DatePicker Date="{Binding EndDate}" />
                        </VerticalStackLayout>

                        <Button
                            Grid.Row="1"
                            Grid.ColumnSpan="2"
                            Text="Appliquer les filtres"
                            Command="{Binding ApplyReservationFiltersCommand}"
                            BackgroundColor="Transparent"
                            BorderColor="{StaticResource GoldText}"
                            BorderWidth="1.5"
                            CornerRadius="10"
                            Padding="12,10" />
                    </Grid>
                </VerticalStackLayout>

                <!-- Recherche -->
                <SearchBar
                    Placeholder="Rechercher une commande"
                    Text="{Binding SearchQuery}"
                    PlaceholderColor="{StaticResource GoldText}"
                    TextColor="{StaticResource GoldText}"
                    BackgroundColor="#121212"
                    CancelButtonColor="{StaticResource GoldText}"
                    SearchCommand="{x:Null}" />

            </VerticalStackLayout>
        </CollectionView.Header>

        <!-- EmptyView -->
        <CollectionView.EmptyView>
            <VerticalStackLayout Padding="24" Spacing="8" HorizontalOptions="Center">
                <ActivityIndicator IsVisible="{Binding IsBusy}" IsRunning="{Binding IsBusy}" />
                <Label Text="Aucune commande à afficher pour cet état." />
            </VerticalStackLayout>
        </CollectionView.EmptyView>

        <!-- ✅ ITEM TEMPLATE -->
        <CollectionView.ItemTemplate>
            <DataTemplate>
                <Border
                    Margin="24,6,24,6"
                    Padding="18"
                    Stroke="{StaticResource GoldText}"
                    StrokeThickness="1.5"
                    BackgroundColor="{StaticResource CardBackground}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="16" />
                    </Border.StrokeShape>

                    <Border.GestureRecognizers>
                        <TapGestureRecognizer
                            Command="{Binding BindingContext.ToggleOrderDetailsCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                            CommandParameter="{Binding .}" />
                    </Border.GestureRecognizers>

                    <Border.Triggers>
                        <DataTrigger Binding="{Binding IsExpanded}" TargetType="Border" Value="True">
                            <Setter Property="StrokeThickness" Value="2.5" />
                            <Setter Property="BackgroundColor" Value="#121212" />
                        </DataTrigger>
                    </Border.Triggers>

                    <VerticalStackLayout Spacing="10">

                        <Grid ColumnDefinitions="*,auto" RowDefinitions="auto,auto,auto" ColumnSpacing="8">
                            <Label Grid.Row="0" Grid.Column="0"
                                   Text="{Binding OrderLabel}"
                                   FontSize="16"
                                   FontAttributes="Bold" />

                            <Label Grid.Row="0" Grid.Column="1"
                                   Text="{Binding DisplayAmount}"
                                   FontSize="15"
                                   HorizontalOptions="End" />

                            <Label Grid.Row="1" Grid.Column="0"
                                   Text="{Binding DisplayDate}"
                                   FontSize="13"
                                   Opacity="0.7" />

                            <Label Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                   Text="{Binding PickupDateDisplay}"
                                   FontSize="13"
                                   Opacity="0.7"
                                   HorizontalOptions="Start"
                                   IsVisible="{Binding HasPickupDate}" />

                            <Border Grid.Row="1" Grid.Column="1"
                                    Stroke="{StaticResource GoldText}"
                                    StrokeThickness="1"
                                    Padding="8,4"
                                    BackgroundColor="#1A1A1A"
                                    HorizontalOptions="End">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                <Label Text="{Binding CurrentStatus}"
                                       FontSize="12"
                                       FontAttributes="Bold" />
                            </Border>
                        </Grid>

                        <Grid RowDefinitions="auto,auto" RowSpacing="10">

                            <Picker
                                ItemsSource="{Binding BindingContext.AvailableStatuses, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                SelectedItem="{Binding SelectedStatusOption, Mode=TwoWay}"
                                BackgroundColor="#121212"
                                Title="Modifier l'état"
                                FontSize="14" />

                            <!-- ✅ Actions (Grid stable) : Supprimer TOUJOURS visible -->
                            <Grid Grid.Row="1"
                                  ColumnDefinitions="Auto,Auto"
                                  ColumnSpacing="10"
                                  HorizontalOptions="End">

                                <Button
                                    Grid.Column="0"
                                    Text="Annuler"
                                    Command="{Binding BindingContext.RevertStatusCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                    CommandParameter="{Binding .}"
                                    IsVisible="{Binding CanRevert}"
                                    BackgroundColor="Transparent"
                                    BorderColor="{StaticResource GoldText}"
                                    BorderWidth="1.5"
                                    CornerRadius="10"
                                    WidthRequest="110"
                                    HeightRequest="40"
                                    TextColor="{StaticResource GoldText}" />

                                <Button
                                    Grid.Column="1"
                                    Text="Supprimer"
                                    Command="{Binding BindingContext.DeleteReservationCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                    CommandParameter="{Binding .}"
                                    IsVisible="True"
                                    BackgroundColor="Transparent"
                                    BorderColor="Tomato"
                                    BorderWidth="1.5"
                                    CornerRadius="10"
                                    WidthRequest="110"
                                    HeightRequest="40"
                                    TextColor="Tomato" />
                            </Grid>

                        </Grid>

                        <!-- Détails -->
                        <VerticalStackLayout Spacing="10" IsVisible="{Binding IsExpanded}">
                            <Border BackgroundColor="#0D0D0D" Padding="10" StrokeThickness="0">
                                <VerticalStackLayout Spacing="6">

                                    <Grid ColumnDefinitions="auto,*" ColumnSpacing="8"
                                          IsVisible="{Binding IsLoadingDetails}">
                                        <ActivityIndicator Grid.Column="0" IsVisible="True" IsRunning="True" />
                                        <Label Grid.Column="1" Text="Chargement des détails..." Opacity="0.8" />
                                    </Grid>

                                    <Label Text="{Binding DetailsError}"
                                           TextColor="Tomato"
                                           IsVisible="{Binding HasDetailsError}" />

                                    <CollectionView ItemsSource="{Binding OrderLines}"
                                                    SelectionMode="None"
                                                    IsVisible="{Binding HasLoadedDetails}"
                                                    ItemSizingStrategy="MeasureFirstItem">

                                        <CollectionView.EmptyView>
                                            <Label Text="Aucun détail trouvé pour cette commande." />
                                        </CollectionView.EmptyView>

                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Grid ColumnDefinitions="*,auto"
                                                      RowDefinitions="auto,auto"
                                                      Padding="8"
                                                      ColumnSpacing="12">

                                                    <VerticalStackLayout Grid.Column="0" Spacing="4">
                                                        <Label Text="{Binding LeProduit.NomProduit}" FontAttributes="Bold" />
                                                        <Label Text="{Binding Quantite, StringFormat='Quantité : {0}'}" Opacity="0.8" />
                                                        <Label Text="{Binding PrixRetenu, StringFormat='Prix : {0:C}'}" Opacity="0.8" />

                                                        <Label Text="À traiter" Opacity="0.8">
                                                            <Label.Triggers>
                                                                <DataTrigger TargetType="Label" Binding="{Binding Livree}" Value="True">
                                                                    <Setter Property="Text" Value="Livré" />
                                                                    <Setter Property="TextColor" Value="#5BE35B" />
                                                                    <Setter Property="Opacity" Value="1" />
                                                                </DataTrigger>
                                                                <DataTrigger TargetType="Label" Binding="{Binding Traite}" Value="True">
                                                                    <Setter Property="Text" Value="Traité" />
                                                                    <Setter Property="TextColor" Value="#5BE35B" />
                                                                    <Setter Property="Opacity" Value="1" />
                                                                </DataTrigger>
                                                            </Label.Triggers>
                                                        </Label>
                                                    </VerticalStackLayout>

                                                    <Grid Grid.Column="1" RowDefinitions="auto,auto" RowSpacing="6">

                                                        <ImageButton
                                                            Grid.Row="0"
                                                            Command="{Binding BindingContext.MarkLineTreatedCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                            CommandParameter="{Binding .}"
                                                            BackgroundColor="#1A1A1A"
                                                            CornerRadius="12"
                                                            Padding="10"
                                                            HorizontalOptions="End">
                                                            <ImageButton.Source>
                                                                <FontImageSource Glyph="&#x2713;" Color="{StaticResource GoldText}" Size="22" />
                                                            </ImageButton.Source>
                                                            <ImageButton.Triggers>
                                                                <DataTrigger TargetType="ImageButton" Binding="{Binding Traite}" Value="True">
                                                                    <Setter Property="Opacity" Value="0.4" />
                                                                    <Setter Property="IsEnabled" Value="False" />
                                                                </DataTrigger>
                                                                <DataTrigger TargetType="ImageButton"
                                                                             Binding="{Binding BindingContext.CurrentStatus, Source={RelativeSource AncestorType={x:Type CollectionView}}}"
                                                                             Value="Traitée">
                                                                    <Setter Property="IsVisible" Value="False" />
                                                                </DataTrigger>
                                                                <DataTrigger TargetType="ImageButton"
                                                                             Binding="{Binding BindingContext.CurrentStatus, Source={RelativeSource AncestorType={x:Type CollectionView}}}"
                                                                             Value="Livrée">
                                                                    <Setter Property="IsVisible" Value="False" />
                                                                </DataTrigger>
                                                            </ImageButton.Triggers>
                                                        </ImageButton>

                                                        <ImageButton
                                                            Grid.Row="1"
                                                            Command="{Binding BindingContext.MarkLineDeliveredCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                            CommandParameter="{Binding .}"
                                                            BackgroundColor="#1A1A1A"
                                                            CornerRadius="12"
                                                            Padding="10"
                                                            HorizontalOptions="End"
                                                            IsVisible="False">
                                                            <ImageButton.Source>
                                                                <FontImageSource Glyph="&#x2714;" Color="{StaticResource GoldText}" Size="22" />
                                                            </ImageButton.Source>
                                                            <ImageButton.Triggers>
                                                                <DataTrigger TargetType="ImageButton"
                                                                             Binding="{Binding BindingContext.CurrentStatus, Source={RelativeSource AncestorType={x:Type CollectionView}}}"
                                                                             Value="Traitée">
                                                                    <Setter Property="IsVisible" Value="True" />
                                                                </DataTrigger>
                                                                <DataTrigger TargetType="ImageButton"
                                                                             Binding="{Binding BindingContext.CurrentStatus, Source={RelativeSource AncestorType={x:Type CollectionView}}}"
                                                                             Value="Livrée">
                                                                    <Setter Property="IsVisible" Value="True" />
                                                                </DataTrigger>
                                                                <DataTrigger TargetType="ImageButton" Binding="{Binding Livree}" Value="True">
                                                                    <Setter Property="Opacity" Value="0.4" />
                                                                    <Setter Property="IsEnabled" Value="False" />
                                                                </DataTrigger>
                                                            </ImageButton.Triggers>
                                                        </ImageButton>

                                                    </Grid>
                                                </Grid>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>

                                </VerticalStackLayout>
                            </Border>
                        </VerticalStackLayout>

                    </VerticalStackLayout>
                </Border>
            </DataTemplate>
        </CollectionView.ItemTemplate>

        <!-- ✅ FOOTER -->
        <CollectionView.Footer>
            <VerticalStackLayout Padding="24" Spacing="12" HorizontalOptions="Center">
                <Button
                    Text="Voir plus"
                    Command="{Binding ShowMoreCommand}"
                    IsVisible="{Binding CanShowMore}"
                    BackgroundColor="Transparent"
                    BorderColor="{StaticResource GoldText}"
                    BorderWidth="1.5"
                    CornerRadius="10"
                    Padding="14,10" />
            </VerticalStackLayout>
        </CollectionView.Footer>

    </CollectionView>

</ContentPage>
