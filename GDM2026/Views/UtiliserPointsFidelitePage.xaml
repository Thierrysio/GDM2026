<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:zxing="clr-namespace:ZXing.Net.Maui.Controls;assembly=ZXing.Net.MAUI.Controls"
             xmlns:viewmodels="clr-namespace:GDM2026.ViewModels"
             x:Class="GDM2026.Views.UtiliserPointsFidelitePage"
             Title="Utiliser Points Fidélité"
             BackgroundColor="#0B0B0B">

    <ContentPage.BindingContext>
        <viewmodels:UtiliserPointsFideliteViewModel />
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <Color x:Key="GoldText">#D4AF37</Color>
        <Color x:Key="CardBackground">#151515</Color>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">

        <!-- Section Scanner (occupe tout l'espace) -->
        <Grid Grid.Row="0" Grid.RowSpan="2" IsVisible="{Binding IsScanning}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Header Scanner -->
            <VerticalStackLayout Grid.Row="0" Padding="24,24,24,12" Spacing="8">
                <Label
                    Text="Utiliser Points Fidélité"
                    FontSize="22"
                    FontAttributes="Bold"
                    TextColor="{StaticResource GoldText}"
                    HorizontalTextAlignment="Center" />
                <Label
                    Text="{Binding StatusMessage}"
                    FontSize="14"
                    TextColor="{StaticResource GoldText}"
                    Opacity="0.8"
                    HorizontalTextAlignment="Center" />
            </VerticalStackLayout>

            <!-- Scanner Camera -->
            <zxing:CameraBarcodeReaderView
                x:Name="BarcodeReader"
                Grid.Row="1"
                Margin="24"
                BarcodesDetected="OnBarcodesDetected" />

            <!-- Status Loading -->
            <VerticalStackLayout Grid.Row="2" Padding="24,12" Spacing="8">
                <ActivityIndicator
                    IsRunning="{Binding IsLoading}"
                    IsVisible="{Binding IsLoading}"
                    Color="{StaticResource GoldText}" />
            </VerticalStackLayout>

            <!-- Boutons Scanner -->
            <HorizontalStackLayout Grid.Row="3"
                                   Padding="24,12,24,24"
                                   Spacing="12"
                                   HorizontalOptions="Center">
                <Button
                    Text="Annuler"
                    Command="{Binding CancelCommand}"
                    BackgroundColor="Transparent"
                    BorderColor="{StaticResource GoldText}"
                    BorderWidth="1.5"
                    TextColor="{StaticResource GoldText}"
                    CornerRadius="10"
                    WidthRequest="120"
                    HeightRequest="50" />

                <Button
                    x:Name="TorchButton"
                    Text="Torche"
                    Clicked="OnTorchClicked"
                    BackgroundColor="#1A1A1A"
                    TextColor="{StaticResource GoldText}"
                    CornerRadius="10"
                    WidthRequest="120"
                    HeightRequest="50" />
            </HorizontalStackLayout>
        </Grid>

        <!-- Section Formulaires (quand le scanner est caché) -->
        <ScrollView Grid.Row="0" Grid.RowSpan="2" IsVisible="{Binding ShowClientInfo}">
            <VerticalStackLayout Spacing="24" Padding="24">

                <!-- Header -->
                <VerticalStackLayout Spacing="8">
                    <Label
                        Text="Utiliser Points Fidélité"
                        FontSize="28"
                        FontAttributes="Bold"
                        TextColor="{StaticResource GoldText}"
                        HorizontalTextAlignment="Center" />
                    <Label
                        Text="{Binding StatusMessage}"
                        FontSize="14"
                        TextColor="{StaticResource GoldText}"
                        Opacity="0.8"
                        HorizontalTextAlignment="Center" />
                </VerticalStackLayout>

                <!-- Informations Client -->
            <Border
                IsVisible="{Binding ShowClientInfo}"
                Stroke="#000000"
                StrokeThickness="1.5"
                BackgroundColor="{StaticResource CardBackground}"
                Padding="20"
                StrokeShape="RoundRectangle 14">
                <VerticalStackLayout Spacing="12">
                    <Label
                        Text="Informations Client"
                        FontSize="18"
                        FontAttributes="Bold"
                        TextColor="{StaticResource GoldText}" />

                    <BoxView
                        HeightRequest="1"
                        Color="{StaticResource GoldText}"
                        Opacity="0.3" />

                    <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                        <Label
                            Grid.Row="0" Grid.Column="0"
                            Text="Nom :"
                            FontSize="14"
                            FontAttributes="Bold"
                            TextColor="{StaticResource GoldText}"
                            VerticalOptions="Center"
                            Margin="0,0,12,0" />
                        <Label
                            Grid.Row="0" Grid.Column="1"
                            Text="{Binding ClientName}"
                            FontSize="14"
                            TextColor="{StaticResource GoldText}"
                            VerticalOptions="Center" />

                        <Label
                            Grid.Row="1" Grid.Column="0"
                            Text="Points :"
                            FontSize="14"
                            FontAttributes="Bold"
                            TextColor="{StaticResource GoldText}"
                            VerticalOptions="Center"
                            Margin="0,0,12,0" />
                        <Label
                            Grid.Row="1" Grid.Column="1"
                            Text="{Binding ClientPoints}"
                            FontSize="14"
                            TextColor="{StaticResource GoldText}"
                            VerticalOptions="Center" />

                        <Label
                            Grid.Row="2" Grid.Column="0"
                            Text="Valeur :"
                            FontSize="14"
                            FontAttributes="Bold"
                            TextColor="{StaticResource GoldText}"
                            VerticalOptions="Center"
                            Margin="0,0,12,0" />
                        <Label
                            Grid.Row="2" Grid.Column="1"
                            Text="{Binding ClientPointsInEuros}"
                            FontSize="14"
                            TextColor="{StaticResource GoldText}"
                            VerticalOptions="Center" />
                    </Grid>
                </VerticalStackLayout>
            </Border>

            <!-- Formulaire de Paiement -->
            <Border
                IsVisible="{Binding ShowPaymentForm}"
                Stroke="#000000"
                StrokeThickness="1.5"
                BackgroundColor="{StaticResource CardBackground}"
                Padding="20"
                StrokeShape="RoundRectangle 14">
                <VerticalStackLayout Spacing="16">
                    <Label
                        Text="Montant à Payer"
                        FontSize="18"
                        FontAttributes="Bold"
                        TextColor="{StaticResource GoldText}" />

                    <BoxView
                        HeightRequest="1"
                        Color="{StaticResource GoldText}"
                        Opacity="0.3" />

                    <VerticalStackLayout Spacing="8">
                        <Label
                            Text="Saisissez le montant total à payer (€) :"
                            FontSize="14"
                            TextColor="{StaticResource GoldText}"
                            Opacity="0.9" />

                        <Entry
                             Text="{Binding AmountToPayText}"
                             Placeholder="Ex: 25.50"
                             Keyboard="Text"
                             TextColor="{StaticResource GoldText}"
                             PlaceholderColor="{StaticResource GoldText}"
                             BackgroundColor="#1A1A1A"
                             FontSize="16"
                             HeightRequest="50" />
                    </VerticalStackLayout>

                    <Button
                        Text="Valider"
                        Command="{Binding ValidateAmountCommand}"
                        BackgroundColor="{StaticResource GoldText}"
                        TextColor="#0B0B0B"
                        FontAttributes="Bold"
                        CornerRadius="10"
                        HeightRequest="50"
                        Margin="0,8,0,0" />
                </VerticalStackLayout>
            </Border>

            <!-- Confirmation Utilisation Points -->
            <Border
                IsVisible="{Binding ShowConfirmation}"
                Stroke="#000000"
                StrokeThickness="1.5"
                BackgroundColor="{StaticResource CardBackground}"
                Padding="20"
                StrokeShape="RoundRectangle 14">
                <VerticalStackLayout Spacing="16">
                    <Label
                        Text="Confirmation"
                        FontSize="18"
                        FontAttributes="Bold"
                        TextColor="{StaticResource GoldText}" />

                    <BoxView
                        HeightRequest="1"
                        Color="{StaticResource GoldText}"
                        Opacity="0.3" />

                    <Label
                        Text="{Binding ConfirmationMessage}"
                        FontSize="14"
                        TextColor="{StaticResource GoldText}"
                        LineBreakMode="WordWrap" />

                    <HorizontalStackLayout Spacing="12" Margin="0,8,0,0">
                        <Button
                            Text="Oui, utiliser les points"
                            Command="{Binding UsePointsCommand}"
                            BackgroundColor="{StaticResource GoldText}"
                            TextColor="#0B0B0B"
                            FontAttributes="Bold"
                            CornerRadius="10"
                            HeightRequest="50"
                            HorizontalOptions="FillAndExpand" />

                        <Button
                            Text="Non"
                            Command="{Binding DontUsePointsCommand}"
                            BackgroundColor="Transparent"
                            BorderColor="{StaticResource GoldText}"
                            BorderWidth="1.5"
                            TextColor="{StaticResource GoldText}"
                            CornerRadius="10"
                            HeightRequest="50"
                            WidthRequest="100" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Border>

            </VerticalStackLayout>
        </ScrollView>

    </Grid>
</ContentPage>
