<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="GDM2026.ReservationsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:GDM2026.ViewModels"
    BackgroundColor="#0B0B0B"
    Title="RÃ©servations">

    <ContentPage.Resources>
        <Color x:Key="GoldText">#D4AF37</Color>
        <Color x:Key="CardBackground">#0B0B0B</Color>
        <Color x:Key="CardBorder">#000000</Color>

        <Style TargetType="Label">
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
        </Style>
        <Style TargetType="Picker">
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
            <Setter Property="TitleColor" Value="{StaticResource GoldText}" />
            <Setter Property="BackgroundColor" Value="Transparent" />
        </Style>
        <Style TargetType="Button">
            <Setter Property="TextColor" Value="{StaticResource GoldText}" />
        </Style>
        <Style TargetType="ActivityIndicator">
            <Setter Property="Color" Value="{StaticResource GoldText}" />
        </Style>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="18">

            <Border
                Background="{StaticResource CardBackground}"
                Stroke="{StaticResource CardBorder}"
                StrokeThickness="1.5"
                Padding="24">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label
                        FontSize="24"
                        FontAttributes="Bold"
                        HorizontalTextAlignment="Center"
                        Text="RÃ©servations"
                        TextColor="{StaticResource GoldText}" />
                    <Label
                        FontSize="14"
                        HorizontalTextAlignment="Center"
                        Opacity="0.85"
                        Text="Les rÃ©servations se chargent automatiquement. Utilisez le scanner QR ou la recherche pour trouver une commande."
                        TextColor="{StaticResource GoldText}" />
                </VerticalStackLayout>
            </Border>

            <!-- Recherche + Scanner QR -->
            <Frame BackgroundColor="#1E1E1E" Padding="12" CornerRadius="16" BorderColor="#2D2D2D" HasShadow="False">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                    <SearchBar
                        Grid.Column="0"
                        Placeholder="Rechercher une commande"
                        Text="{Binding SearchQuery}"
                        PlaceholderColor="{StaticResource GoldText}"
                        TextColor="{StaticResource GoldText}"
                        BackgroundColor="#121212"
                        CancelButtonColor="{StaticResource GoldText}"
                        SearchCommand="{x:Null}" />
                    <Button
                        Grid.Column="1"
                        Text="ðŸ“· QR"
                        Command="{Binding ScanOrderQrCodeCommand}"
                        BackgroundColor="#2D2D2D"
                        BorderColor="{StaticResource GoldText}"
                        BorderWidth="1.5"
                        CornerRadius="10"
                        TextColor="{StaticResource GoldText}"
                        WidthRequest="80"
                        HeightRequest="44"
                        VerticalOptions="Center" />
                </Grid>
            </Frame>

            <!-- RÃ©sultat du scan QR : affichÃ© directement sous la recherche -->
            <Border
                Background="#121212"
                Stroke="{StaticResource GoldText}"
                StrokeThickness="2.5"
                Padding="18"
                IsVisible="{Binding IsScannedOrderVisible}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16" />
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="10">

                    <!-- Bandeau titre + fermer -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label
                            Grid.Column="0"
                            Text="RÃ©sultat du scan"
                            FontSize="16"
                            FontAttributes="Bold"
                            TextColor="{StaticResource GoldText}" />
                        <Button
                            Grid.Column="1"
                            Text="âœ•"
                            Command="{Binding DismissScannedOrderCommand}"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource GoldText}"
                            FontSize="18"
                            WidthRequest="40"
                            HeightRequest="40"
                            Padding="0" />
                    </Grid>

                    <!-- En-tÃªte commande : label, montant, date, statut -->
                    <Grid ColumnDefinitions="*,auto" RowDefinitions="auto,auto,auto,auto" ColumnSpacing="8">
                        <Label
                            Grid.Row="0" Grid.Column="0"
                            Text="{Binding ScannedOrderEntry.OrderLabel}"
                            FontSize="16"
                            FontAttributes="Bold"
                            TextColor="{StaticResource GoldText}" />
                        <Label
                            Grid.Row="0" Grid.Column="1"
                            Text="{Binding ScannedOrderEntry.DisplayAmountWithReduction}"
                            FontSize="15"
                            TextColor="{StaticResource GoldText}"
                            HorizontalOptions="End" />

                        <!-- RÃ©duction fidÃ©litÃ© -->
                        <HorizontalStackLayout
                            Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                            Spacing="8"
                            IsVisible="{Binding ScannedOrderEntry.HasLoyaltyReduction}">
                            <Label Text="ðŸ‘‘" FontSize="14" VerticalOptions="Center" />
                            <Label
                                Text="{Binding ScannedOrderEntry.DisplayLoyaltyReduction}"
                                FontSize="13" TextColor="#5BE35B" FontAttributes="Bold" VerticalOptions="Center" />
                            <Label
                                Text="{Binding ScannedOrderEntry.DisplayLoyaltyCouronnes}"
                                FontSize="12" Opacity="0.8" VerticalOptions="Center" />
                        </HorizontalStackLayout>

                        <Label
                            Grid.Row="2" Grid.Column="0"
                            Text="{Binding ScannedOrderEntry.DisplayDate}"
                            FontSize="13" Opacity="0.7"
                            TextColor="{StaticResource GoldText}" />

                        <Label
                            Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2"
                            Text="{Binding ScannedOrderEntry.PickupDateDisplay}"
                            FontSize="13" Opacity="0.7"
                            TextColor="{StaticResource GoldText}"
                            HorizontalOptions="Start"
                            IsVisible="{Binding ScannedOrderEntry.HasPickupDate}" />

                        <Border
                            Grid.Row="2" Grid.Column="1"
                            Stroke="{StaticResource GoldText}"
                            StrokeThickness="1"
                            Padding="8,4"
                            BackgroundColor="#1A1A1A"
                            HorizontalOptions="End">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12" />
                            </Border.StrokeShape>
                            <Label
                                Text="{Binding ScannedOrderEntry.CurrentStatus}"
                                FontSize="12" FontAttributes="Bold"
                                TextColor="{StaticResource GoldText}" />
                        </Border>
                    </Grid>

                    <!-- Actions : picker Ã©tat + boutons -->
                    <Grid ColumnDefinitions="*,auto" RowDefinitions="auto,auto" ColumnSpacing="12" RowSpacing="6">
                        <VerticalStackLayout Spacing="4" Grid.Row="0" Grid.Column="0">
                            <Picker
                                ItemsSource="{Binding AvailableStatuses}"
                                SelectedItem="{Binding ScannedOrderEntry.SelectedStatusOption, Mode=TwoWay}"
                                BackgroundColor="#121212"
                                Title="Modifier l'Ã©tat"
                                FontSize="14"
                                TextColor="{StaticResource GoldText}"
                                TitleColor="{StaticResource GoldText}" />
                        </VerticalStackLayout>

                        <FlexLayout
                            Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                            Wrap="Wrap" JustifyContent="End"
                            AlignItems="Start" AlignContent="Start">

                            <Button
                                Text="ðŸ‘‘ FidÃ©litÃ©"
                                Command="{Binding OpenLoyaltyScannerCommand}"
                                CommandParameter="{Binding ScannedOrderEntry}"
                                IsVisible="{Binding ScannedOrderEntry.CanUseLoyalty}"
                                BackgroundColor="#2D2D2D"
                                BorderColor="#FFD700"
                                BorderWidth="1.5"
                                CornerRadius="10"
                                WidthRequest="110"
                                Margin="5,5,0,0"
                                TextColor="#FFD700" />

                            <Button
                                Text="Annuler"
                                Command="{Binding RevertStatusCommand}"
                                CommandParameter="{Binding ScannedOrderEntry}"
                                IsVisible="{Binding ScannedOrderEntry.CanRevert}"
                                BackgroundColor="Transparent"
                                BorderColor="{StaticResource GoldText}"
                                BorderWidth="1.5"
                                CornerRadius="10"
                                WidthRequest="110"
                                Margin="5,5,0,0"
                                TextColor="{StaticResource GoldText}" />

                            <Button
                                Text="Supprimer"
                                Command="{Binding DeleteReservationCommand}"
                                CommandParameter="{Binding ScannedOrderEntry}"
                                BackgroundColor="Transparent"
                                BorderColor="Tomato"
                                BorderWidth="1.5"
                                CornerRadius="10"
                                WidthRequest="110"
                                Margin="5,5,0,0"
                                TextColor="Tomato" />
                        </FlexLayout>
                    </Grid>

                    <!-- DÃ©tails expandÃ©s : lignes de commande -->
                    <Border BackgroundColor="#0D0D0D" Padding="10" StrokeThickness="0">
                        <VerticalStackLayout Spacing="6">

                            <Grid ColumnDefinitions="auto,*" ColumnSpacing="8"
                                  IsVisible="{Binding ScannedOrderEntry.IsLoadingDetails}">
                                <ActivityIndicator Grid.Column="0" IsVisible="True" IsRunning="True" />
                                <Label Grid.Column="1" Text="Chargement des dÃ©tails..." Opacity="0.8" />
                            </Grid>

                            <Label
                                Text="{Binding ScannedOrderEntry.DetailsError}"
                                TextColor="Tomato"
                                IsVisible="{Binding ScannedOrderEntry.HasDetailsError}" />

                            <CollectionView
                                x:Name="ScannedOrderLinesView"
                                ItemsSource="{Binding ScannedOrderEntry.OrderLines}"
                                SelectionMode="None"
                                IsVisible="{Binding ScannedOrderEntry.HasLoadedDetails}">
                                <CollectionView.EmptyView>
                                    <Label Text="Aucun dÃ©tail trouvÃ© pour cette commande." />
                                </CollectionView.EmptyView>

                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="*,auto" RowDefinitions="auto,auto" Padding="8" ColumnSpacing="12">
                                            <VerticalStackLayout Grid.Column="0" Spacing="2">
                                                <Label Text="{Binding LeProduit.NomProduit}" FontAttributes="Bold" />
                                                <Label Text="{Binding Quantite, StringFormat='QuantitÃ© : {0}'}" Opacity="0.8" />
                                                <Label Text="{Binding PrixRetenu, StringFormat='Prix : {0:C}'}" Opacity="0.8" />
                                                <Label Text="Ã€ traiter" Opacity="0.8">
                                                    <Label.Triggers>
                                                        <DataTrigger TargetType="Label" Binding="{Binding Traite}" Value="True">
                                                            <Setter Property="Text" Value="TraitÃ©" />
                                                            <Setter Property="TextColor" Value="#5BE35B" />
                                                            <Setter Property="Opacity" Value="1" />
                                                        </DataTrigger>
                                                    </Label.Triggers>
                                                </Label>
                                                <Label Text="LivrÃ©" TextColor="#5BE35B" FontAttributes="Bold" IsVisible="False">
                                                    <Label.Triggers>
                                                        <DataTrigger TargetType="Label" Binding="{Binding Livree}" Value="True">
                                                            <Setter Property="IsVisible" Value="True" />
                                                        </DataTrigger>
                                                    </Label.Triggers>
                                                </Label>
                                            </VerticalStackLayout>

                                            <Grid Grid.Column="1" ColumnDefinitions="auto" RowDefinitions="auto,auto" RowSpacing="6">
                                                <ImageButton
                                                    Grid.Row="0"
                                                    Command="{Binding BindingContext.MarkLineTreatedCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#1A1A1A"
                                                    CornerRadius="12"
                                                    Padding="10"
                                                    HorizontalOptions="End"
                                                    VerticalOptions="Center">
                                                    <ImageButton.Source>
                                                        <FontImageSource Glyph="&#x2713;" Color="{StaticResource GoldText}" Size="22" />
                                                    </ImageButton.Source>
                                                    <ImageButton.Triggers>
                                                        <DataTrigger TargetType="ImageButton" Binding="{Binding Traite}" Value="True">
                                                            <Setter Property="Opacity" Value="0.4" />
                                                            <Setter Property="IsEnabled" Value="False" />
                                                        </DataTrigger>
                                                    </ImageButton.Triggers>
                                                </ImageButton>

                                                <ImageButton
                                                    Grid.Row="1"
                                                    Command="{Binding BindingContext.MarkLineDeliveredCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#1A1A1A"
                                                    CornerRadius="12"
                                                    Padding="10"
                                                    HorizontalOptions="End"
                                                    VerticalOptions="Center"
                                                    IsVisible="False">
                                                    <ImageButton.Source>
                                                        <FontImageSource Glyph="&#x1F464;" Color="{StaticResource GoldText}" Size="22" />
                                                    </ImageButton.Source>
                                                    <ImageButton.Triggers>
                                                        <DataTrigger TargetType="ImageButton" Binding="{Binding Livree}" Value="True">
                                                            <Setter Property="Opacity" Value="0.4" />
                                                            <Setter Property="IsEnabled" Value="False" />
                                                        </DataTrigger>
                                                    </ImageButton.Triggers>
                                                </ImageButton>
                                            </Grid>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                        </VerticalStackLayout>
                    </Border>

                </VerticalStackLayout>
            </Border>

            <Frame BackgroundColor="#1E1E1E" Padding="16" CornerRadius="16" BorderColor="#2D2D2D" HasShadow="False">
                <VerticalStackLayout Spacing="12">
                    <Label Text="PÃ©riode" FontAttributes="Bold" TextColor="{StaticResource GoldText}" />
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                        <VerticalStackLayout Spacing="6" Grid.Column="0">
                            <Label Text="Date dÃ©but" FontAttributes="Bold" />
                            <DatePicker Date="{Binding StartDate}" TextColor="{StaticResource GoldText}" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Spacing="6" Grid.Column="1">
                            <Label Text="Date fin" FontAttributes="Bold" />
                            <DatePicker Date="{Binding EndDate}" TextColor="{StaticResource GoldText}" />
                        </VerticalStackLayout>
                    </Grid>
                    <Label
                        Text="Ajustez la pÃ©riode et l'Ã©tat pour filtrer les rÃ©servations."
                        FontSize="13"
                        TextColor="{StaticResource GoldText}"
                        Opacity="0.75" />
                </VerticalStackLayout>
            </Frame>

            <Frame BackgroundColor="#1E1E1E" Padding="16" CornerRadius="16" BorderColor="#2D2D2D" HasShadow="False">
                <VerticalStackLayout Spacing="12">
                    <Label Text="Ã‰tat de rÃ©servation" FontAttributes="Bold" TextColor="{StaticResource GoldText}" />
                    <CollectionView ItemsSource="{Binding ReservationStatuses}" SelectionMode="None">
                        <CollectionView.ItemsLayout>
                            <GridItemsLayout Orientation="Vertical" Span="2" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    Margin="6"
                                    Padding="12"
                                    Background="#1F1F1F"
                                    Stroke="{StaticResource GoldText}"
                                    StrokeThickness="1.2">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="14" />
                                    </Border.StrokeShape>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding BindingContext.SelectReservationStatusCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                            CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                    <Border.Triggers>
                                        <DataTrigger Binding="{Binding IsSelected}" TargetType="Border" Value="True">
                                            <Setter Property="Background" Value="#2A2A2A" />
                                            <Setter Property="StrokeThickness" Value="2" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                    <VerticalStackLayout Spacing="4">
                                        <Label
                                            Text="{Binding Status}"
                                            FontSize="16"
                                            FontAttributes="Bold" />
                                        <Label
                                            Text="{Binding DisplayCount}"
                                            FontSize="13"
                                            Opacity="0.8" />
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                    <Label Text="{Binding Subtitle}" FontSize="13" TextColor="{StaticResource GoldText}" Opacity="0.75" />
                </VerticalStackLayout>
            </Frame>

            <!-- Indicateur de chargement automatique -->
            <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" HeightRequest="30" />

            <CollectionView ItemsSource="{Binding Orders}" SelectionMode="None">
                <CollectionView.EmptyView>
                    <VerticalStackLayout Padding="12" Spacing="6" HorizontalOptions="Center">
                        <ActivityIndicator IsVisible="{Binding IsBusy}" IsRunning="{Binding IsBusy}" />
                        <Label Text="Aucune rÃ©servation trouvÃ©e pour ces critÃ¨res." TextColor="{StaticResource GoldText}" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border
                            Margin="0,6"
                            Padding="18"
                            Stroke="{StaticResource GoldText}"
                            StrokeThickness="1.5"
                            BackgroundColor="{StaticResource CardBackground}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>

                            <Border.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding BindingContext.ToggleOrderDetailsCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                    CommandParameter="{Binding .}" />
                            </Border.GestureRecognizers>

                            <Border.Triggers>
                                <DataTrigger Binding="{Binding IsExpanded}" TargetType="Border" Value="True">
                                    <Setter Property="StrokeThickness" Value="2.5" />
                                    <Setter Property="BackgroundColor" Value="#121212" />
                                </DataTrigger>
                            </Border.Triggers>

                            <VerticalStackLayout Spacing="10">

                                <Grid ColumnDefinitions="*,auto" RowDefinitions="auto,auto,auto,auto" ColumnSpacing="8">
                                    <Label
                                        Grid.Row="0"
                                        Grid.Column="0"
                                        Text="{Binding OrderLabel}"
                                        FontSize="16"
                                        FontAttributes="Bold"
                                        TextColor="{StaticResource GoldText}" />

                                    <Label
                                        Grid.Row="0"
                                        Grid.Column="1"
                                        Text="{Binding DisplayAmountWithReduction}"
                                        FontSize="15"
                                        TextColor="{StaticResource GoldText}"
                                        HorizontalOptions="End" />

                                    <!-- Affichage de la rÃ©duction fidÃ©litÃ© si appliquÃ©e -->
                                    <HorizontalStackLayout
                                        Grid.Row="1"
                                        Grid.Column="0"
                                        Grid.ColumnSpan="2"
                                        Spacing="8"
                                        IsVisible="{Binding HasLoyaltyReduction}">
                                        <Label
                                            Text="ðŸ‘‘"
                                            FontSize="14"
                                            VerticalOptions="Center" />
                                        <Label
                                            Text="{Binding DisplayLoyaltyReduction}"
                                            FontSize="13"
                                            TextColor="#5BE35B"
                                            FontAttributes="Bold"
                                            VerticalOptions="Center" />
                                        <Label
                                            Text="{Binding DisplayLoyaltyCouronnes}"
                                            FontSize="12"
                                            Opacity="0.8"
                                            VerticalOptions="Center" />
                                    </HorizontalStackLayout>

                                    <Label
                                        Grid.Row="2"
                                        Grid.Column="0"
                                        Text="{Binding DisplayDate}"
                                        FontSize="13"
                                        Opacity="0.7"
                                        TextColor="{StaticResource GoldText}" />

                                    <Label
                                        Grid.Row="3"
                                        Grid.Column="0"
                                        Grid.ColumnSpan="2"
                                        Text="{Binding PickupDateDisplay}"
                                        FontSize="13"
                                        Opacity="0.7"
                                        TextColor="{StaticResource GoldText}"
                                        HorizontalOptions="Start"
                                        IsVisible="{Binding HasPickupDate}" />

                                    <Border
                                        Grid.Row="2"
                                        Grid.Column="1"
                                        Stroke="{StaticResource GoldText}"
                                        StrokeThickness="1"
                                        Padding="8,4"
                                        BackgroundColor="#1A1A1A"
                                        HorizontalOptions="End">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>
                                        <Label
                                            Text="{Binding CurrentStatus}"
                                            FontSize="12"
                                            FontAttributes="Bold"
                                            TextColor="{StaticResource GoldText}" />
                                    </Border>
                                </Grid>

                                <Grid ColumnDefinitions="*,auto" RowDefinitions="auto,auto" ColumnSpacing="12" RowSpacing="6">

                                    <VerticalStackLayout Spacing="4" Grid.Row="0" Grid.Column="0">
                                        <Picker
                                            ItemsSource="{Binding BindingContext.AvailableStatuses, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                            SelectedItem="{Binding SelectedStatusOption, Mode=TwoWay}"
                                            BackgroundColor="#121212"
                                            Title="Modifier l'Ã©tat"
                                            FontSize="14"
                                            TextColor="{StaticResource GoldText}"
                                            TitleColor="{StaticResource GoldText}" />
                                    </VerticalStackLayout>

                                    <FlexLayout
                                        Grid.Row="1"
                                        Grid.Column="0"
                                        Grid.ColumnSpan="2"
                                        Wrap="Wrap"
                                        JustifyContent="End"
                                        AlignItems="Start"
                                        AlignContent="Start">

                                        <!-- Bouton Porte-monnaie FidÃ©litÃ© -->
                                        <Button
                                            Text="ðŸ‘‘ FidÃ©litÃ©"
                                            Command="{Binding BindingContext.OpenLoyaltyScannerCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                            CommandParameter="{Binding .}"
                                            IsVisible="{Binding CanUseLoyalty}"
                                            BackgroundColor="#2D2D2D"
                                            BorderColor="#FFD700"
                                            BorderWidth="1.5"
                                            CornerRadius="10"
                                            WidthRequest="110"
                                            Margin="5,5,0,0"
                                            TextColor="#FFD700" />

                                        <Button
                                            Text="Annuler"
                                            Command="{Binding BindingContext.RevertStatusCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                            CommandParameter="{Binding .}"
                                            IsVisible="{Binding CanRevert}"
                                            BackgroundColor="Transparent"
                                            BorderColor="{StaticResource GoldText}"
                                            BorderWidth="1.5"
                                            CornerRadius="10"
                                            WidthRequest="110"
                                            Margin="5,5,0,0"
                                            TextColor="{StaticResource GoldText}" />

                                        <Button
                                            Text="Supprimer"
                                            Command="{Binding BindingContext.DeleteReservationCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="Transparent"
                                            BorderColor="Tomato"
                                            BorderWidth="1.5"
                                            CornerRadius="10"
                                            WidthRequest="110"
                                            Margin="5,5,0,0"
                                            TextColor="Tomato" />

                                    </FlexLayout>

                                </Grid>

                                <VerticalStackLayout Spacing="10" IsVisible="{Binding IsExpanded}">
                                    <Border BackgroundColor="#0D0D0D" Padding="10" StrokeThickness="0">
                                        <VerticalStackLayout Spacing="6">

                                            <Grid ColumnDefinitions="auto,*" ColumnSpacing="8" IsVisible="{Binding IsLoadingDetails}">
                                                <ActivityIndicator Grid.Column="0" IsVisible="True" IsRunning="True" />
                                                <Label Grid.Column="1" Text="Chargement des dÃ©tails..." Opacity="0.8" />
                                            </Grid>

                                            <Label
                                                Text="{Binding DetailsError}"
                                                TextColor="Tomato"
                                                IsVisible="{Binding HasDetailsError}" />

                                            <CollectionView
                                                ItemsSource="{Binding OrderLines}"
                                                SelectionMode="None"
                                                IsVisible="{Binding HasLoadedDetails}">
                                                <CollectionView.EmptyView>
                                                    <Label Text="Aucun dÃ©tail trouvÃ© pour cette commande." />
                                                </CollectionView.EmptyView>

                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid ColumnDefinitions="*,auto" RowDefinitions="auto,auto" Padding="8" ColumnSpacing="12">
                                                            <VerticalStackLayout Grid.Column="0" Spacing="2">
                                                                <Label Text="{Binding LeProduit.NomProduit}" FontAttributes="Bold" />
                                                                <Label Text="{Binding Quantite, StringFormat='QuantitÃ© : {0}'}" Opacity="0.8" />
                                                                <Label Text="{Binding PrixRetenu, StringFormat='Prix : {0:C}'}" Opacity="0.8" />
                                                                <Label Text="Ã€ traiter" Opacity="0.8">
                                                                    <Label.Triggers>
                                                                        <DataTrigger TargetType="Label" Binding="{Binding Traite}" Value="True">
                                                                            <Setter Property="Text" Value="TraitÃ©" />
                                                                            <Setter Property="TextColor" Value="#5BE35B" />
                                                                            <Setter Property="Opacity" Value="1" />
                                                                        </DataTrigger>
                                                                    </Label.Triggers>
                                                                </Label>
                                                                <Label Text="LivrÃ©" TextColor="#5BE35B" FontAttributes="Bold" IsVisible="False">
                                                                    <Label.Triggers>
                                                                        <DataTrigger TargetType="Label" Binding="{Binding Livree}" Value="True">
                                                                            <Setter Property="IsVisible" Value="True" />
                                                                        </DataTrigger>
                                                                    </Label.Triggers>
                                                                </Label>
                                                            </VerticalStackLayout>

                                                            <Grid Grid.Column="1" ColumnDefinitions="auto" RowDefinitions="auto,auto" RowSpacing="6">
                                                                <ImageButton
                                                                    Grid.Row="0"
                                                                    Command="{Binding BindingContext.MarkLineTreatedCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                                    CommandParameter="{Binding .}"
                                                                    BackgroundColor="#1A1A1A"
                                                                    CornerRadius="12"
                                                                    Padding="10"
                                                                    HorizontalOptions="End"
                                                                    VerticalOptions="Center">
                                                                    <ImageButton.Source>
                                                                        <FontImageSource Glyph="&#x2713;" Color="{StaticResource GoldText}" Size="22" />
                                                                    </ImageButton.Source>
                                                                    <ImageButton.Triggers>
                                                                        <DataTrigger TargetType="ImageButton" Binding="{Binding Traite}" Value="True">
                                                                            <Setter Property="Opacity" Value="0.4" />
                                                                            <Setter Property="IsEnabled" Value="False" />
                                                                        </DataTrigger>
                                                                        <DataTrigger TargetType="ImageButton"
                                                                                     Binding="{Binding BindingContext.CurrentStatus, Source={RelativeSource AncestorType={x:Type CollectionView}}}"
                                                                                     Value="TraitÃ©e">
                                                                            <Setter Property="IsVisible" Value="False" />
                                                                        </DataTrigger>
                                                                        <DataTrigger TargetType="ImageButton"
                                                                                     Binding="{Binding BindingContext.CurrentStatus, Source={RelativeSource AncestorType={x:Type CollectionView}}}"
                                                                                     Value="LivrÃ©e">
                                                                            <Setter Property="IsVisible" Value="False" />
                                                                        </DataTrigger>
                                                                    </ImageButton.Triggers>
                                                                </ImageButton>

                                                                <ImageButton
                                                                    Grid.Row="1"
                                                                    Command="{Binding BindingContext.MarkLineDeliveredCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                                    CommandParameter="{Binding .}"
                                                                    BackgroundColor="#1A1A1A"
                                                                    CornerRadius="12"
                                                                    Padding="10"
                                                                    HorizontalOptions="End"
                                                                    VerticalOptions="Center"
                                                                    IsVisible="False">
                                                                    <ImageButton.Source>
                                                                        <FontImageSource Glyph="&#x1F464;" Color="{StaticResource GoldText}" Size="22" />
                                                                    </ImageButton.Source>
                                                                    <ImageButton.Triggers>
                                                                        <DataTrigger TargetType="ImageButton"
                                                                                     Binding="{Binding BindingContext.CurrentStatus, Source={RelativeSource AncestorType={x:Type CollectionView}}}"
                                                                                     Value="TraitÃ©e">
                                                                            <Setter Property="IsVisible" Value="True" />
                                                                        </DataTrigger>
                                                                        <DataTrigger TargetType="ImageButton"
                                                                                     Binding="{Binding BindingContext.CurrentStatus, Source={RelativeSource AncestorType={x:Type CollectionView}}}"
                                                                                     Value="LivrÃ©e">
                                                                            <Setter Property="IsVisible" Value="True" />
                                                                        </DataTrigger>
                                                                        <DataTrigger TargetType="ImageButton" Binding="{Binding Livree}" Value="True">
                                                                            <Setter Property="Opacity" Value="0.4" />
                                                                            <Setter Property="IsEnabled" Value="False" />
                                                                        </DataTrigger>
                                                                    </ImageButton.Triggers>
                                                                </ImageButton>
                                                            </Grid>
                                                        </Grid>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>

                                        </VerticalStackLayout>
                                    </Border>
                                </VerticalStackLayout>

                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Button
                Text="Voir plus"
                Command="{Binding ShowMoreCommand}"
                IsVisible="{Binding CanShowMore}"
                BackgroundColor="Transparent"
                BorderColor="{StaticResource GoldText}"
                BorderWidth="1.5"
                CornerRadius="10"
                TextColor="{StaticResource GoldText}"
                Padding="14,10"
                HorizontalOptions="Center" />

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
