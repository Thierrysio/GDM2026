<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:GDM2026.ViewModels"
             x:Class="GDM2026.Views.PromoPage"
             x:Name="PromoPageRoot"
             x:DataType="viewModels:PromoPageViewModel"
             BackgroundColor="#0B0B0B"
             Title="Promotions">

    <ContentPage.Resources>
        <Color x:Key="GoldText">#D4AF37</Color>
        <Color x:Key="CardBackground">#151515</Color>
    </ContentPage.Resources>

    <Shell.BackButtonBehavior>
        <BackButtonBehavior Command="{Binding GoBackCommand}" />
    </Shell.BackButtonBehavior>

    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="18">
            <Border
                Background="{StaticResource CardBackground}"
                Stroke="#000000"
                StrokeThickness="1.5"
                Padding="20">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18" />
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="16">
                    <Label
                        Text="Promotions"
                        FontSize="28"
                        FontAttributes="Bold"
                        HorizontalTextAlignment="Center"
                        TextColor="{StaticResource GoldText}" />

                    <Label
                        Text="Choisissez d'abord le type de promotion à créer."
                        FontSize="16"
                        HorizontalTextAlignment="Center"
                        TextColor="{StaticResource GoldText}"
                        Opacity="0.85" />

                    <!-- Sélection de la catégorie promo via Picker -->
                    <Border
                        Background="#1E1E1E"
                        Padding="14"
                        Stroke="#2D2D2D">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="14" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="12">
                            <Label
                                Text="Type de promotion"
                                FontAttributes="Bold"
                                TextColor="{StaticResource GoldText}"
                                FontSize="18" />

                            <ActivityIndicator
                                IsRunning="{Binding IsCategoriesLoading}"
                                IsVisible="{Binding IsCategoriesLoading}"
                                Color="{StaticResource GoldText}" />

                            <Picker
                                Title="Sélectionnez une catégorie"
                                ItemsSource="{Binding AvailableCategories}"
                                ItemDisplayBinding="{Binding DisplayName}"
                                SelectedItem="{Binding SelectedCategoryPicker}"
                                TextColor="{StaticResource GoldText}"
                                TitleColor="#7E7030"
                                BackgroundColor="#121212"
                                IsVisible="{Binding IsCategoriesLoaded}" />

                            <Label
                                Text="{Binding CategoryPickerStatus}"
                                TextColor="{StaticResource GoldText}"
                                FontSize="13"
                                Opacity="0.8"
                                HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Boutons de mode (visibles après sélection de catégorie non-flash) -->
                    <VerticalStackLayout Spacing="10" IsVisible="{Binding IsStandardModeVisible}">
                        <Button
                            Text="+ Nouvelle promotion"
                            BackgroundColor="#303030"
                            TextColor="{StaticResource GoldText}"
                            Command="{Binding ShowCreatePanelCommand}" />
                        <Button
                            Text="Mettre à jour une promotion"
                            BackgroundColor="#303030"
                            TextColor="{StaticResource GoldText}"
                            Command="{Binding ShowUpdatePanelCommand}" />
                        <Button
                            Text="Recharger les promotions"
                            BackgroundColor="#252525"
                            TextColor="{StaticResource GoldText}"
                            Command="{Binding RefreshPromosCommand}" />
                    </VerticalStackLayout>

                    <!-- FORMULAIRE PROMO FLASH -->
                    <Border
                        IsVisible="{Binding IsFlashMode}"
                        Background="#1E1E1E"
                        Padding="14"
                        Stroke="#C18F1A"
                        StrokeThickness="2">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="14" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="14">
                            <Label
                                Text="Promotion Flash"
                                FontAttributes="Bold"
                                TextColor="{StaticResource GoldText}"
                                FontSize="20"
                                HorizontalTextAlignment="Center" />

                            <Label
                                Text="Créez une offre flash avec quantité limitée et date de disponibilité."
                                TextColor="{StaticResource GoldText}"
                                FontSize="13"
                                Opacity="0.8"
                                HorizontalTextAlignment="Center" />

                            <!-- Sélection du produit -->
                            <Label Text="Produit" TextColor="{StaticResource GoldText}" FontAttributes="Bold" />
                            <Picker
                                Title="Choisir un produit"
                                ItemsSource="{Binding FlashProductList}"
                                ItemDisplayBinding="{Binding DisplayName}"
                                SelectedItem="{Binding FlashSelectedProduct}"
                                TextColor="{StaticResource GoldText}"
                                TitleColor="#7E7030"
                                BackgroundColor="#121212" />
                            <Label
                                Text="{Binding FlashSelectedProductLabel}"
                                FontSize="12"
                                TextColor="{StaticResource GoldText}"
                                Opacity="0.7" />

                            <!-- Prix promo -->
                            <Label Text="Prix promotionnel" TextColor="{StaticResource GoldText}" FontAttributes="Bold" />
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Entry
                                    Placeholder="Ex: 9.99"
                                    Keyboard="Default"
                                    Text="{Binding FlashPrix}"
                                    TextColor="{StaticResource GoldText}"
                                    PlaceholderColor="#777"
                                    BackgroundColor="#121212" />
                                <Label
                                    Grid.Column="1"
                                    Text="EUR"
                                    TextColor="{StaticResource GoldText}"
                                    VerticalOptions="Center"
                                    FontAttributes="Bold" />
                            </Grid>

                            <!-- Quantité avec Stepper -->
                            <Label Text="Quantité disponible" TextColor="{StaticResource GoldText}" FontAttributes="Bold" />
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                                <Button
                                    Grid.Column="0"
                                    Text="-"
                                    WidthRequest="50"
                                    HeightRequest="44"
                                    BackgroundColor="#303030"
                                    TextColor="{StaticResource GoldText}"
                                    FontSize="20"
                                    Command="{Binding DecrementQuantityCommand}" />
                                <Border
                                    Grid.Column="1"
                                    Background="#121212"
                                    Stroke="#2D2D2D"
                                    Padding="10,8">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="8" />
                                    </Border.StrokeShape>
                                    <Label
                                        Text="{Binding FlashQuantite}"
                                        TextColor="{StaticResource GoldText}"
                                        FontSize="18"
                                        FontAttributes="Bold"
                                        HorizontalTextAlignment="Center"
                                        VerticalTextAlignment="Center" />
                                </Border>
                                <Button
                                    Grid.Column="2"
                                    Text="+"
                                    WidthRequest="50"
                                    HeightRequest="44"
                                    BackgroundColor="#303030"
                                    TextColor="{StaticResource GoldText}"
                                    FontSize="20"
                                    Command="{Binding IncrementQuantityCommand}" />
                            </Grid>
                            <Label
                                Text="Quantités rapides:"
                                TextColor="{StaticResource GoldText}"
                                FontSize="12"
                                Opacity="0.7" />
                            <HorizontalStackLayout Spacing="8">
                                <Button Text="10" WidthRequest="55" HeightRequest="36" BackgroundColor="#252525" TextColor="{StaticResource GoldText}" FontSize="14" Command="{Binding SetQuantityCommand}" CommandParameter="10" />
                                <Button Text="25" WidthRequest="55" HeightRequest="36" BackgroundColor="#252525" TextColor="{StaticResource GoldText}" FontSize="14" Command="{Binding SetQuantityCommand}" CommandParameter="25" />
                                <Button Text="50" WidthRequest="55" HeightRequest="36" BackgroundColor="#252525" TextColor="{StaticResource GoldText}" FontSize="14" Command="{Binding SetQuantityCommand}" CommandParameter="50" />
                                <Button Text="100" WidthRequest="55" HeightRequest="36" BackgroundColor="#252525" TextColor="{StaticResource GoldText}" FontSize="14" Command="{Binding SetQuantityCommand}" CommandParameter="100" />
                            </HorizontalStackLayout>

                            <!-- Période de précommande -->
                            <Label Text="Période de précommande" TextColor="{StaticResource GoldText}" FontAttributes="Bold" />
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="8">
                                <Label Grid.Row="0" Grid.ColumnSpan="2" Text="Début" TextColor="{StaticResource GoldText}" FontSize="12" Opacity="0.7" />
                                <DatePicker Grid.Row="1" Grid.Column="0"
                                            Date="{Binding FlashDateDebutDate}"
                                            TextColor="{StaticResource GoldText}"
                                            BackgroundColor="#121212" />
                                <TimePicker Grid.Row="1" Grid.Column="1"
                                            Time="{Binding FlashDateDebutTime}"
                                            TextColor="{StaticResource GoldText}"
                                            BackgroundColor="#121212" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="8">
                                <Label Grid.Row="0" Grid.ColumnSpan="2" Text="Fin" TextColor="{StaticResource GoldText}" FontSize="12" Opacity="0.7" />
                                <DatePicker Grid.Row="1" Grid.Column="0"
                                            Date="{Binding FlashDateFinDate}"
                                            TextColor="{StaticResource GoldText}"
                                            BackgroundColor="#121212" />
                                <TimePicker Grid.Row="1" Grid.Column="1"
                                            Time="{Binding FlashDateFinTime}"
                                            TextColor="{StaticResource GoldText}"
                                            BackgroundColor="#121212" />
                            </Grid>

                            <!-- Date de disponibilité -->
                            <Label Text="Date de disponibilité (livraison/retrait)" TextColor="{StaticResource GoldText}" FontAttributes="Bold" />
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <DatePicker Grid.Column="0"
                                            Date="{Binding FlashDateDispoDate}"
                                            TextColor="{StaticResource GoldText}"
                                            BackgroundColor="#121212" />
                                <TimePicker Grid.Column="1"
                                            Time="{Binding FlashDateDispoTime}"
                                            TextColor="{StaticResource GoldText}"
                                            BackgroundColor="#121212" />
                            </Grid>

                            <ActivityIndicator
                                IsRunning="{Binding IsBusy}"
                                IsVisible="{Binding IsBusy}"
                                Color="{StaticResource GoldText}" />

                            <Button
                                Text="Créer la promo flash"
                                Command="{Binding CreateFlashPromoCommand}"
                                BackgroundColor="#C18F1A"
                                TextColor="#0B0B0B"
                                FontAttributes="Bold"
                                HeightRequest="50" />

                            <Label
                                Text="{Binding FlashStatusMessage}"
                                TextColor="{StaticResource GoldText}"
                                FontSize="13"
                                Opacity="0.85"
                                HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Liste des promos existantes (mode mise à jour standard) -->
                    <Border
                        IsVisible="{Binding IsUpdateMode}"
                        Background="#1E1E1E"
                        Padding="14"
                        Stroke="#2D2D2D">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="14" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="12">
                            <Label
                                Text="Sélectionnez une promotion à modifier"
                                FontAttributes="Bold"
                                TextColor="{StaticResource GoldText}" />

                            <ActivityIndicator
                                IsRunning="{Binding IsPromosLoading}"
                                IsVisible="{Binding IsPromosLoading}"
                                Color="{StaticResource GoldText}" />

                            <CollectionView
                                ItemsSource="{Binding Promos}"
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedPromo}"
                                HeightRequest="230">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="8" />
                                </CollectionView.ItemsLayout>
                                <CollectionView.EmptyView>
                                    <Label
                                        Text="Aucune promotion n'a encore été chargée."
                                        TextColor="{StaticResource GoldText}"
                                        HorizontalTextAlignment="Center"
                                        Opacity="0.6" />
                                </CollectionView.EmptyView>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#111" Stroke="#2D2D2D" StrokeThickness="1" Padding="10" Margin="0,4">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12" />
                                            </Border.StrokeShape>
                                            <VerticalStackLayout Spacing="4">
                                                <Label
                                                    Text="{Binding DisplayPeriod}"
                                                    TextColor="{StaticResource GoldText}"
                                                    FontAttributes="Bold" />
                                                <Label
                                                    Text="{Binding DisplayPrix}"
                                                    TextColor="{StaticResource GoldText}"
                                                    FontSize="13" />
                                                <Label
                                                    Text="{Binding DisplayProductName}"
                                                    TextColor="{StaticResource GoldText}"
                                                    FontSize="12" />
                                                <Label
                                                    Text="{Binding DisplayCategoryName}"
                                                    TextColor="{StaticResource GoldText}"
                                                    FontSize="12" />
                                            </VerticalStackLayout>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                            <Label
                                Text="{Binding PromosStatusMessage}"
                                TextColor="{StaticResource GoldText}"
                                FontSize="13"
                                Opacity="0.85"
                                HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </Border>

                    <Border
                        IsVisible="{Binding IsFormSectionVisible}"
                        Background="#1E1E1E"
                        Padding="14"
                        Stroke="#C18F1A"
                        StrokeThickness="2">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="14" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="14">
                            <Label
                                Text="{Binding FormHeader}"
                                FontAttributes="Bold"
                                TextColor="{StaticResource GoldText}"
                                FontSize="20"
                                HorizontalTextAlignment="Center" />

                            <Label
                                Text="{Binding FormHelperMessage}"
                                TextColor="{StaticResource GoldText}"
                                FontSize="13"
                                Opacity="0.8"
                                HorizontalTextAlignment="Center" />

                            <!-- Catégorie sélectionnée (lecture seule) -->
                            <Border Background="#121212" Stroke="#2D2D2D" Padding="12,10">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10" />
                                </Border.StrokeShape>
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="Catégorie:" TextColor="{StaticResource GoldText}" FontAttributes="Bold" VerticalOptions="Center" />
                                    <Label Text="{Binding SelectedCategoryLabel}" TextColor="{StaticResource GoldText}" VerticalOptions="Center" Opacity="0.9" />
                                </HorizontalStackLayout>
                            </Border>

                            <!-- Sélection du produit via Picker -->
                            <Label Text="Produit" TextColor="{StaticResource GoldText}" FontAttributes="Bold" />
                            <Picker
                                Title="Choisir un produit"
                                ItemsSource="{Binding StandardProductList}"
                                ItemDisplayBinding="{Binding DisplayName}"
                                SelectedItem="{Binding SelectedProduct}"
                                TextColor="{StaticResource GoldText}"
                                TitleColor="#7E7030"
                                BackgroundColor="#121212" />
                            <Label
                                Text="{Binding SelectedProductPriceLabel}"
                                FontSize="12"
                                TextColor="{StaticResource GoldText}"
                                Opacity="0.7" />

                            <!-- Prix promo -->
                            <Label Text="Prix promotionnel" TextColor="{StaticResource GoldText}" FontAttributes="Bold" />
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Entry
                                    Placeholder="Ex: 9.99"
                                    Keyboard="Numeric"
                                    Text="{Binding PrixText}"
                                    TextColor="{StaticResource GoldText}"
                                    PlaceholderColor="#777"
                                    BackgroundColor="#121212" />
                                <Label
                                    Grid.Column="1"
                                    Text="EUR"
                                    TextColor="{StaticResource GoldText}"
                                    VerticalOptions="Center"
                                    FontAttributes="Bold" />
                            </Grid>

                            <!-- Période de promotion -->
                            <Label Text="Période de promotion" TextColor="{StaticResource GoldText}" FontAttributes="Bold" />
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="8">
                                <Label Grid.Row="0" Grid.ColumnSpan="2" Text="Début" TextColor="{StaticResource GoldText}" FontSize="12" Opacity="0.7" />
                                <DatePicker Grid.Row="1" Grid.Column="0"
                                            Date="{Binding DateDebutDate}"
                                            TextColor="{StaticResource GoldText}"
                                            BackgroundColor="#121212" />
                                <TimePicker Grid.Row="1" Grid.Column="1"
                                            Time="{Binding DateDebutTime}"
                                            TextColor="{StaticResource GoldText}"
                                            BackgroundColor="#121212" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="8">
                                <Label Grid.Row="0" Grid.ColumnSpan="2" Text="Fin" TextColor="{StaticResource GoldText}" FontSize="12" Opacity="0.7" />
                                <DatePicker Grid.Row="1" Grid.Column="0"
                                            Date="{Binding DateFinDate}"
                                            TextColor="{StaticResource GoldText}"
                                            BackgroundColor="#121212" />
                                <TimePicker Grid.Row="1" Grid.Column="1"
                                            Time="{Binding DateFinTime}"
                                            TextColor="{StaticResource GoldText}"
                                            BackgroundColor="#121212" />
                            </Grid>

                            <ActivityIndicator
                                IsRunning="{Binding IsBusy}"
                                IsVisible="{Binding IsBusy}"
                                Color="{StaticResource GoldText}" />

                            <Button
                                Text="Créer la promotion"
                                Command="{Binding CreatePromoCommand}"
                                BackgroundColor="#C18F1A"
                                TextColor="#0B0B0B"
                                FontAttributes="Bold"
                                HeightRequest="50"
                                IsVisible="{Binding IsCreateMode}" />

                            <Button
                                Text="Mettre à jour la promotion"
                                Command="{Binding UpdatePromoCommand}"
                                BackgroundColor="#C18F1A"
                                TextColor="#0B0B0B"
                                FontAttributes="Bold"
                                HeightRequest="50"
                                IsVisible="{Binding IsUpdateMode}" />

                            <Label
                                Text="{Binding StatusMessage}"
                                TextColor="{StaticResource GoldText}"
                                FontSize="13"
                                Opacity="0.85"
                                HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </Border>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
